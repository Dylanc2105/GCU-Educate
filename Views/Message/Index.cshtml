@{
    ViewBag.Title = "Messages";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />

<style>
    body {
        background: #f5f5fa;
    }

    .dm-container {
        max-width: 1400px;
        min-width: 900px;
        margin: 32px auto 0;
        height: 540px;
        border-radius: 14px;
        background: #f5f5fa;
        box-shadow: 0 4px 32px rgb(127 61 152 / 0.10);
        display: flex;
        overflow: hidden;
    }

    .inbox-pane {
        width: 40%;
        background: #fff;
        border-right: 1.5px solid #eee;
        display: flex;
        flex-direction: column;
        min-width: 320px;
    }

    .inbox-header {
        font-size: 1.23em;
        font-weight: 700;
        color: #7F3D98;
        background: #fff;
        border-bottom: 1px solid #eee;
        padding: 20px 30px 12px 30px;
        position: sticky;
        top: 0;
        z-index: 3;
    }

    .inbox-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 14px 26px 14px 26px;
        background: #fff;
        border-bottom: 1px solid #eee;
        position: sticky;
        top: 60px;
        z-index: 2;
    }

    #inboxSearch {
        flex-grow: 1;
        padding: 8px 16px;
        border: 1.2px solid #d4cbe5;
        border-radius: 8px;
        font-size: 1em;
        background: #faf6ff;
        color: #422759;
        outline: none;
        transition: border .2s;
    }

        #inboxSearch:focus {
            border: 1.7px solid #7F3D98;
        }

    #roleFilter {
        padding: 8px 10px;
        border: 1.2px solid #d4cbe5;
        border-radius: 8px;
        font-size: 1em;
        background: #faf6ff;
        color: #7F3D98;
        outline: none;
    }

    #newChatBtn {
        background: #7F3D98;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1em;
        font-weight: 700;
        padding: 11px 32px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 180px;
        max-width: 220px;
        box-shadow: 0 0 10px rgb(127 61 152 / 0.18);
    }

        #newChatBtn:hover {
            background: #642b7b;
        }

    #viewArchiveBtn {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f5f5fa;
        color: #7F3D98;
        border: 1.5px solid #eee;
        border-radius: 10px;
        font-size: 1em;
        padding: 11px 22px;
        font-weight: 700;
        cursor: pointer;
        min-width: 120px;
        max-width: 160px;
    }

        #viewArchiveBtn:hover {
            background: #ece1f9;
        }

    #inboxList {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0 10px 0 10px;
        background: #fff;
    }

    .inbox-item {
        display: flex;
        flex-direction: column;
        padding: 13px 28px 11px 28px;
        border-bottom: 1px solid #f0f0f0;
        position: relative;
        cursor: pointer;
        user-select: none;
        transition: background 0.14s;
    }

        .inbox-item:hover {
            background: #f6edff;
        }

    .inbox-item-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0;
    }

    .inbox-meta {
        display: flex;
        align-items: center;
        min-width: 0;
    }

    .message-name {
        font-weight: 700;
        font-size: 1em;
        color: #7F3D98;
        margin-right: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 140px;
    }

        .message-name.unread {
            font-weight: 900;
        }

    .message-role {
        font-size: 0.84em;
        color: #9162b8;
        font-weight: 600;
        margin-right: 10px;
        white-space: nowrap;
    }

    .online-dot, .offline-dot {
        display: inline-block;
        width: 9px;
        height: 9px;
        border-radius: 50%;
        margin-right: 6px;
    }

    .online-dot {
        background: #28a745;
    }

    .offline-dot {
        background: #bababa;
    }

    .message-preview-date {
        display: flex;
        justify-content: space-between;
        font-size: 0.89em;
        color: #555;
        margin-top: 3px;
        gap: 12px;
    }

    .message-preview {
        flex-grow: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 250px;
    }

    .message-date {
        white-space: nowrap;
        color: #bbb;
    }

    .pin-icon {
        font-size: 16px;
        margin-left: 6px;
    }

    .options-icon {
        font-size: 21px;
        margin-left: 12px;
        cursor: pointer;
        background: none;
        border: none;
        color: #9672b6;
        opacity: 0;
        transition: opacity .18s;
        position: relative;
        z-index: 5;
        padding: 0;
    }

    .inbox-item:hover .options-icon {
        opacity: 1;
    }

    .options-menu {
        display: none;
        position: absolute;
        right: 25px;
        bottom: 8px;
        background: #fff;
        border: 1.2px solid #d1c1e0;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(127,61,152,0.09);
        min-width: 130px;
        z-index: 30;
        overflow: hidden;
        transition: opacity .12s;
    }

        .options-menu.show {
            display: block;
        }

        .options-menu div {
            padding: 10px 18px 9px 18px;
            font-size: 1em;
            cursor: pointer;
            color: #7F3D98;
            background: none;
            border: none;
            text-align: left;
            font-weight: 600;
            transition: background .13s;
        }

            .options-menu div:hover {
                background: #f4eaff;
                color: #511a75;
            }

    .chat-pane {
        width: 60%;
        display: flex;
        flex-direction: column;
        background: #f5f5fa;
        border-left: 1.5px solid #eee;
        min-width: 420px;
    }

    .chat-header {
        padding: 20px 36px 14px 36px;
        border-bottom: 1px solid #eee;
        font-size: 1.08em;
        font-weight: 700;
        background: #fafafa;
        color: #7F3D98;
        display: flex;
        align-items: center;
        transition: background 0.18s, color 0.18s;
    }

        .chat-header .status-label {
            margin-left: 8px;
            font-weight: 600;
            font-size: 0.96em;
        }

        .chat-header.archived {
            background: #ededed !important;
            color: #757575 !important;
        }

    .chat-body {
        flex-grow: 1;
        padding: 20px 36px 16px 36px;
        overflow-y: auto;
        background: #fcfbfe;
        font-size: 1em;
    }

    .chat-footer {
        padding: 15px 36px 13px 36px;
        border-top: 1px solid #eee;
        display: flex;
        background: #fafafa;
    }

        .chat-footer input {
            flex-grow: 1;
            padding: 10px 18px;
            border-radius: 22px;
            border: 1.5px solid #bda9da;
            outline: none;
            font-size: 1em;
            background: #fff;
            color: #333;
            margin-right: 12px;
        }

        .chat-footer button {
            background: #7F3D98;
            border: none;
            color: white;
            padding: 10px 24px;
            border-radius: 24px;
            font-weight: 700;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 0 8px rgb(127 61 152 / 0.1);
            margin-right: 8px;
            transition: background .2s;
        }

            .chat-footer button:disabled {
                opacity: .45;
            }

            .chat-footer button:hover:not(:disabled) {
                background: #642b7b;
            }

    #linkDropdownBtn {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2em;
        background: #7F3D98;
        margin-right: 0;
        color: #fff;
        border: none;
        transition: background .2s;
    }

        #linkDropdownBtn:disabled {
            opacity: .45;
        }

        #linkDropdownBtn:hover:not(:disabled) {
            background: #642b7b;
        }

    .chat-message {
        display: flex;
        margin-bottom: 9px;
        user-select: text;
        font-size: 1em;
        line-height: 1.32;
    }

        .chat-message.mine {
            justify-content: flex-end;
        }

        .chat-message.theirs {
            justify-content: flex-start;
        }

    .msg-bubble {
        max-width: 62%;
        padding: 9px 14px;
        border-radius: 14px;
        background: #eee;
        box-shadow: 0 1px 3px rgb(127 61 152 / 0.07);
        word-break: break-word;
        font-size: 1em;
        line-height: 1.35;
    }

    .chat-message.mine .msg-bubble {
        background: #7F3D98;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .chat-message.theirs .msg-bubble {
        background: #f0f0f0;
        color: #222;
        border-bottom-left-radius: 4px;
    }

    .msg-name {
        font-weight: 700;
        font-size: 0.82em;
        margin-bottom: 4px;
    }

    .msg-time {
        font-size: 0.70em;
        color: #b3a2c3;
        text-align: right;
        margin-top: 6px;
    }
    /* Modal style for New Chat & Link popup */
    .modal-content {
        width: 860px !important;
        max-height: 68vh !important;
        padding: 24px 32px 32px 32px !important;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 12px 40px #9f8db852;
        border: 2.2px solid #e4d8fa;
        display: flex;
        flex-direction: column;
    }

    .modal-header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        color: #7F3D98;
        margin-bottom: 7px;
        font-size: 1.42em;
        font-weight: 700;
    }

    .close-modal-btn {
        background: #f1e5ff;
        border: none;
        color: #7F3D98;
        padding: 7px 22px;
        border-radius: 18px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1em;
    }

        .close-modal-btn:hover {
            background: #ede1fa;
        }

    .modal-toolbar {
        display: flex;
        gap: 14px;
        margin: 16px 0 10px 0;
    }

        .modal-toolbar input, .modal-toolbar select {
            width: 44%;
            min-width: 120px;
            padding: 9px 14px;
            border: 1.2px solid #e2d0fa;
            border-radius: 9px;
            background: #fcfbfe;
            color: #542b7a;
            font-size: 1em;
        }

            .modal-toolbar input:focus, .modal-toolbar select:focus {
                border: 1.7px solid #7F3D98;
            }

    .modal-table-scroll {
        max-height: 350px;
        overflow-y: auto;
        border-radius: 12px;
        border: 1.2px solid #e7d6fb;
    }

    .modal-user-table, .modal-issue-table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
    }

        .modal-user-table th, .modal-issue-table th, .modal-user-table td, .modal-issue-table td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #ede4fb;
            vertical-align: middle;
        }

        .modal-user-table th, .modal-issue-table th {
            background: #f5f5fa;
            color: #7F3D98;
            font-weight: 700;
            font-size: 1.01em;
        }

        .modal-user-table tr:hover, .modal-issue-table tr:hover {
            background: #f9f5fd;
            cursor: pointer;
        }

    .start-chat-btn, .link-btn {
        background: #7F3D98;
        border: none;
        color: white;
        padding: 7px 18px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1em;
        transition: background-color 0.22s;
        box-shadow: 0 1px 4px #e7d0fa34;
    }

        .start-chat-btn:hover, .link-btn:hover {
            background: #642b7b;
        }
    /* Mini Issue Card Styles for Chat */
    .mini-issue-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 1.5px 6px #bda9da27;
        padding: 14px 17px 13px 17px;
        margin: 8px 0 3px 0;
        border-left: 5px solid #7F3D98;
        max-width: 380px;
        font-family: inherit;
    }

    .mini-issue-title {
        font-size: 1.12em;
        font-weight: 700;
        color: #7F3D98;
        margin-bottom: 2px;
        word-break: break-word;
    }

    .mini-issue-meta {
        font-size: 0.93em;
        color: #7F3D98;
        margin-bottom: 4px;
    }

        .mini-issue-meta b {
            color: #5C2D7A;
        }

    .mini-issue-date {
        margin-right: 15px;
    }

    .mini-issue-status {
        color: #7F3D98;
    }

    .mini-issue-desc {
        font-size: 1em;
        color: #444;
        margin-bottom: 7px;
        word-break: break-word;
    }

    .mini-issue-btn {
        background: #7F3D98;
        color: #fff;
        padding: 5px 16px;
        border-radius: 7px;
        text-decoration: none;
        font-weight: 700;
        font-size: 0.96em;
        transition: background 0.15s;
        display: inline-block;
    }

        .mini-issue-btn:hover,
        .mini-issue-btn:focus {
            background: #642b7b;
            color: #fff;
        }

    #settingsBtn:hover {
        color: #642b7b;
        background: #ede1fa;
        border-radius: 50%;
    }

    /* Make SweetAlert2 .swal2-question (the question mark) purple */
    .swal2-question {
        color: #7F3D98 !important;
    }
    /* Make SweetAlert2 confirm button purple, even the checkmark SVG */
    .swal2-confirm {
        background-color: #7F3D98 !important;
        border-color: #7F3D98 !important;
    }

        .swal2-confirm:focus, .swal2-confirm:hover {
            background-color: #642b7b !important;
            border-color: #642b7b !important;
        }

    .swal2-icon.swal2-success .swal2-success-ring {
        border: 4px solid #7F3D98 !important;
    }

    .swal2-icon.swal2-success [class^='swal2-success-line'] {
        background-color: #7F3D98 !important;
    }

</style>

<div class="dm-container" role="main" aria-label="Messages Interface">
    <section class="inbox-pane" id="inboxPane" aria-label="Message Inbox">
        <header class="inbox-header" style="display: flex; align-items: center; justify-content: space-between;">
            <span>Message Inbox</span>
            <button id="archiveHeaderBtn" title="View Archived"
                    style="background: none; border: none; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; margin-left: 12px; cursor:pointer;">
                <!-- White file cabinet SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 20 20" fill="none">
                    <rect x="2" y="4" width="16" height="12" rx="2" stroke="#fff" stroke-width="2" fill="#7F3D98" />
                    <rect x="6" y="10" width="8" height="2" rx="1" fill="#fff" />
                    <rect x="7" y="6" width="6" height="2" rx="1" fill="#fff" />
                </svg>
            </button>

        </header>
        <div class="inbox-controls" style="display: flex; gap: 10px; align-items: center; padding: 14px 26px;">
            <input type="search" id="inboxSearch"
                   placeholder="Search…" aria-label="Search conversations"
                   oninput="applyInboxFilters()"
                   style="flex: 0 0 220px; min-width: 180px; max-width: 240px;" />

            <select id="roleFilter" aria-label="Filter conversations by role" onchange="applyInboxFilters()"
                    style="flex: 0 0 110px; min-width: 80px; max-width: 110px;">
                <option value="">All Roles</option>
            </select>

            <button id="newChatBtn"
                    title="New Chat"
                    aria-haspopup="dialog"
                    aria-expanded="false">
                <span style="font-size: 1.23em; line-height: 1;">+</span> New Chat
            </button>
        </div>
        <div id="inboxList" tabindex="0" aria-live="polite" aria-relevant="additions"></div>
    </section>
    <section class="chat-pane" aria-label="Chat window">
        <header class="chat-header" id="chatHeader" tabindex="0">No conversation selected</header>
        <section class="chat-body" id="chatBody" tabindex="0" aria-live="polite" aria-relevant="additions">
            <div class="chat-placeholder">Select a conversation to begin</div>
        </section>
        <footer class="chat-footer">
            <input type="text" placeholder="Type a message..." aria-label="Message input" disabled />
            <button aria-label="Send message" disabled>Send</button>
            <button id="linkDropdownBtn" title="Link" aria-haspopup="menu" aria-expanded="false" disabled>📎</button>
        </footer>
    </section>
</div>

<!-- Reusable Modal (for new chat, link, and archive popups) -->
<div id="customModal" style="display:none; position:fixed; z-index:1200; left:0; right:0; top:0; bottom:0; background:rgba(127,61,152,0.07); justify-content:center; align-items:center;">
    <div class="modal-content" role="document">
        <div class="modal-header-bar">
            <span class="modal-title" id="customModalTitle">Title</span>
            <button onclick="closeCustomModal()" class="close-modal-btn" style="margin-top:0;margin-bottom:0;">Close</button>
        </div>
        <div class="modal-toolbar" id="customModalToolbar"></div>
        <div class="modal-table-scroll">
            <table id="customModalTable" class="modal-user-table" aria-label="Popup table">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
<!-- Archived Conversations Modal -->
<div id="archiveModal" style="display:none; position:fixed; z-index:1500; left:0; right:0; top:0; bottom:0; background:rgba(127,61,152,0.15); justify-content:center; align-items:center;">
    <div class="modal-content" style="max-width:680px; width:95%; border:2px solid #e0e0e0; background:#fafafa;">
        <div class="modal-header-bar">
            <span class="modal-title" id="archiveModalTitle">Archived Conversations</span>
            <button onclick="closeArchiveModal()" class="close-modal-btn">Close</button>
        </div>
        <div class="modal-toolbar">
            <input type="search" id="archiveModalSearch" placeholder="Search archived..." oninput="filterArchiveModalTable()" />
        </div>
        <div class="modal-table-scroll" style="max-height:300px;">
            <table id="archiveModalTable" class="modal-user-table" aria-label="Archive table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Preview</th>
                        <th>Archived At</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let fullInbox = [], fullUsers = [], currentConversationId = null, modalMode = '';
        let currentConversationRole = null;
        let archiveList = [];
        let isArchiveOpen = false;
        let lastArchiveConvoId = null;

        document.addEventListener("DOMContentLoaded", function () {
            loadInbox();
            document.getElementById('newChatBtn').addEventListener('click', openNewChatModal);
            document.getElementById('linkDropdownBtn').addEventListener('click', openLinkDropdownModal);
            document.getElementById('archiveHeaderBtn').addEventListener('click', openArchiveModal);
            document.querySelector('.chat-footer button[aria-label="Send message"]').addEventListener('click', sendMessage);
            document.querySelector('.chat-footer input').addEventListener('keydown', e => {
                if (e.key === 'Enter') sendMessage();
            });
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.options-icon') && !e.target.closest('.options-menu')) closeAllOptionsMenus();
                if (isArchiveOpen && !e.target.closest('#archiveModal') && !e.target.closest('#archiveHeaderBtn')) clearArchiveChatPane();
            });
        });

        async function loadInbox() {
            const res = await fetch('/Message/Inbox');
            const data = await res.json();
            fullInbox = data.conversations;
            populateRoleFilter(data.roles);
            renderInbox(fullInbox);
        }
        function populateRoleFilter(roles) {
            const roleSelect = document.getElementById('roleFilter');
            roleSelect.innerHTML = '<option value="">All Roles</option>';
            roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role;
                option.textContent = role;
                roleSelect.appendChild(option);
            });
        }
        function applyInboxFilters() {
            const searchTerm = document.getElementById('inboxSearch').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            const filtered = fullInbox.filter(convo => {
                const matchName = convo.Name.toLowerCase().includes(searchTerm);
                const matchRole = roleFilter === '' || convo.Role === roleFilter;
                return matchName && matchRole;
            });
            renderInbox(filtered);
        }
        function renderInbox(conversations) {
            const list = document.getElementById('inboxList');
            list.innerHTML = '';
            if (conversations.length === 0) {
                list.innerHTML = '<p style="padding: 20px; color:#888;">No conversations found.</p>';
                return;
            }
            conversations.forEach(convo => {
                const div = document.createElement('div');
                div.classList.add('inbox-item');
                div.dataset.convoId = convo.Id;
                div.onclick = () => openConversation(convo.Id, convo.Name);
                const isUnread = convo.UnreadCount > 0;
                div.innerHTML = `
                        <div class="inbox-item-top">
                            <div class="inbox-meta">
                                <span class="message-name ${isUnread ? 'unread' : ''}">${convo.Name}</span>
                                <span class="message-role">${convo.Role}</span>
                                <span class="${convo.IsOnline ? 'online-dot' : 'offline-dot'}" title="${convo.IsOnline ? 'Online' : 'Offline'}"></span>
                            </div>
                            <div style="position:relative;">
                                <span class="options-icon" onclick="event.stopPropagation();toggleOptionsMenu(event, ${convo.Id})">⋮</span>
                                <div class="options-menu" id="options-menu-${convo.Id}">
                                    <div onclick="event.stopPropagation();archiveConversation(event, ${convo.Id})">Archive Conversation</div>
                                </div>
                            </div>
                        </div>
                        <div class="message-preview-date">
                            <span class="message-preview">${convo.LastMessage ?? '(No messages yet)'}</span>
                            <span class="message-date">${formatDate(convo.UpdatedAt)}</span>
                        </div>`;
                list.appendChild(div);
            });
        }
        function toggleOptionsMenu(e, convoId) {
            e.stopPropagation();
            closeAllOptionsMenus();
            const menu = document.getElementById(`options-menu-${convoId}`);
            if (menu) menu.classList.toggle('show');
        }
        function closeAllOptionsMenus() {
            document.querySelectorAll('.options-menu.show').forEach(menu => menu.classList.remove('show'));
        }
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date)) return '';
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) + ' ' + date.toLocaleDateString();
        }
        async function openConversation(id, name) {
            currentConversationId = id;
            lastArchiveConvoId = null;
            const res = await fetch(`/Message/GetMessages?conversationId=${id}`);
            const data = await res.json();

            currentConversationRole = data.Role;

            const header = document.getElementById('chatHeader');
            header.classList.remove('archived');
            header.innerHTML = `
                    <span class="${data.IsOnline ? 'online-dot' : 'offline-dot'}"></span>
                    ${name}
                    <span class="status-label">${data.IsOnline ? 'Online' : 'Offline'}</span>`;

            document.getElementById('chatBody').innerHTML = '';
            data.Messages.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.classList.add('chat-message', msg.IsMine ? 'mine' : 'theirs');
                let contentHtml = '';
                if (msg.Content.includes('mini-issue-card') || msg.Content.includes('mini-meeting-card')) {
                    contentHtml = msg.Content;
                } else {
                    contentHtml = `
                            <div class="msg-name">${msg.SenderName}</div>
                            <div class="msg-content">${msg.Content}</div>
                            <div class="msg-time">${formatDate(msg.SentAt)}</div>`;
                }
                msgDiv.innerHTML = `<div class="msg-bubble">${contentHtml}</div>`;
                document.getElementById('chatBody').appendChild(msgDiv);
            });
            document.getElementById('chatBody').scrollTop = document.getElementById('chatBody').scrollHeight;

            // Enable input
            document.querySelector('.chat-footer input').disabled = false;
            document.querySelector('.chat-footer button[aria-label="Send message"]').disabled = false;
            document.getElementById('linkDropdownBtn').disabled = false;

            fetch('/Message/MarkAllAsRead', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `conversationId=${id}`
            }).then(() => loadInbox());
        }

        // Archive Modal Logic
        async function openArchiveModal() {
            isArchiveOpen = true;
            document.getElementById('archiveModal').style.display = 'flex';
            document.getElementById('archiveModalSearch').value = '';
            // Load archived conversations from the server
            const res = await fetch('/Message/GetArchivedConversations');
            archiveList = await res.json();
            renderArchiveModalTable(archiveList);
        }
        function renderArchiveModalTable(list) {
            const tbody = document.querySelector('#archiveModalTable tbody');
            tbody.innerHTML = '';
            if (!list || list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" style="color:#888; text-align:center; padding: 32px 0;">No archived conversations.</td></tr>`;
                return;
            }
            list.forEach(c => {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                tr.onclick = () => openArchivedConversation(c.Id, c.Name, c.ArchivedAt);
                tr.innerHTML = `
                        <td>${c.Name}</td>
                        <td>${c.LastMessage ? c.LastMessage.substring(0, 48) : '(No messages)'}</td>
                        <td>${formatDate(c.ArchivedAt)}</td>
                    `;
                tbody.appendChild(tr);
            });
        }
        function filterArchiveModalTable() {
            const search = document.getElementById('archiveModalSearch').value.toLowerCase();
            const filtered = archiveList.filter(c =>
                c.Name.toLowerCase().includes(search) ||
                (c.LastMessage && c.LastMessage.toLowerCase().includes(search))
            );
            renderArchiveModalTable(filtered);
        }
        function closeArchiveModal() {
            isArchiveOpen = false;
            document.getElementById('archiveModal').style.display = 'none';
            clearArchiveChatPane();
        }
        // Archive Chat Rendering
        async function openArchivedConversation(id, name, archivedAt) {
            isArchiveOpen = true;
            lastArchiveConvoId = id;
            document.getElementById('archiveModal').style.display = 'none';

            // Get archived messages for this conversation
            const res = await fetch(`/Message/GetArchivedMessages?conversationId=${id}`);
            const data = await res.json();

            // 1. Gray out the chat header and show archive details
            const header = document.getElementById('chatHeader');
            header.classList.add('archived');
            header.innerHTML = `
        <span style="font-weight:bold;">(Archived)</span>
        <span class="offline-dot"></span>
        ${name}
        <span class="status-label" style="margin-left:14px;">Archived: ${formatDate(archivedAt)}</span>
    `;

            // 2. Display all messages
            const chatBody = document.getElementById('chatBody');
            chatBody.innerHTML = '';
            (data.Messages || []).forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.classList.add('chat-message', msg.IsMine ? 'mine' : 'theirs');
                let contentHtml = '';
                if (msg.Content.includes('mini-issue-card') || msg.Content.includes('mini-meeting-card')) {
                    contentHtml = msg.Content;
                } else {
                    contentHtml = `
                <div class="msg-name">${msg.SenderName}</div>
                <div class="msg-content">${msg.Content}</div>
                <div class="msg-time">${formatDate(msg.SentAt)}</div>
            `;
                }
                msgDiv.innerHTML = `<div class="msg-bubble">${contentHtml}</div>`;
                chatBody.appendChild(msgDiv);
            });
            chatBody.scrollTop = chatBody.scrollHeight;

            // 3. Disable the input and send/link buttons
            document.querySelector('.chat-footer input').disabled = true;
            document.querySelector('.chat-footer button[aria-label="Send message"]').disabled = true;
            document.getElementById('linkDropdownBtn').disabled = true;
        }


        // Clicking outside modal or away from chat clears archive view
        function clearArchiveChatPane() {
            if (lastArchiveConvoId) {
                lastArchiveConvoId = null;
                // Blank chat pane
                const header = document.getElementById('chatHeader');
                header.classList.remove('archived');
                header.innerHTML = 'No conversation selected';
                document.getElementById('chatBody').innerHTML = '<div class="chat-placeholder">Select a conversation to begin</div>';
                document.querySelector('.chat-footer input').disabled = true;
                document.querySelector('.chat-footer button[aria-label="Send message"]').disabled = true;
                document.getElementById('linkDropdownBtn').disabled = true;
            }
            // Hide modal if it's open
            document.getElementById('archiveModal').style.display = 'none';
            isArchiveOpen = false;
        }

        // ---------- NEW CHAT / LINK POPUPS & FILTERS ----------

        function closeCustomModal() {
            document.getElementById('customModal').style.display = 'none';
        }

        async function openNewChatModal() {
            modalMode = "chat";
            const res = await fetch('/Message/GetAvailableUsers');
            fullUsers = await res.json();
            showCustomModal("Start New Chat", "User", fullUsers, startConversation);
        }

        async function openLinkDropdownModal() {
            if (!currentConversationId) {
                Swal.fire({
                    icon: 'info',
                    text: 'Select a conversation first.',
                    customClass: { popup: 'swal2-theme-purple' }
                });
                return;
            }
            // Only allow certain link options based on role
            let inputOptions = {};
            if (currentConversationRole === "Student") {
                inputOptions = { meeting: 'Link Meeting' };
            } else {
                inputOptions = { issue: 'Link Issue', meeting: 'Link Meeting' };
            }
            Swal.fire({
                title: 'Link Message',
                input: 'select',
                inputOptions: inputOptions,
                inputPlaceholder: 'Select link type',
                showCancelButton: true,
                confirmButtonText: 'Proceed',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#7F3D98',
                width: '350px',
                customClass: { popup: 'swal2-theme-purple' }
            }).then(async (result) => {
                if (!result.value) return;
                if (result.value === "issue") openLinkIssueModal();
                if (result.value === "meeting") openLinkMeetingModal();
            });
        }

        async function openLinkIssueModal() {
            modalMode = "issue";
            const res = await fetch('/Issue/GetUserIssues');
            const issues = await res.json();
            showCustomModal("Link Issue", "Issue", issues, linkIssue);
        }

        async function openLinkMeetingModal() {
            modalMode = "meeting";
            const res = await fetch('/Appointment/GetUserMeetings');
            const meetings = await res.json();
            showCustomModal("Link Meeting", "Meeting", meetings, linkMeeting);
        }

        function showCustomModal(title, type, items, callback) {
            document.getElementById('customModalTitle').textContent = title;
            // toolbar
            const toolbar = document.getElementById('customModalToolbar');
            toolbar.innerHTML = `
                    <input type="search" id="customModalSearch" placeholder="Search ${type.toLowerCase()}s..." oninput="filterCustomModalTable()" />
                    ${type === "User"
                    ? `<select id="customModalRoleFilter" onchange="filterCustomModalTable()"><option value="">All Roles</option></select>`
                    : `<span style="flex:1"></span>`}
                `;
            // fill table
            fillCustomModalTable(type, items, callback);
            // fill role filter if needed
            if (type === "User") {
                const roleSel = document.getElementById('customModalRoleFilter');
                roleSel.innerHTML = '<option value="">All Roles</option>';
                [...new Set(items.map(u => u.Role))].forEach(role => {
                    const option = document.createElement('option');
                    option.value = role;
                    option.textContent = role;
                    roleSel.appendChild(option);
                });
            }
            document.getElementById('customModal').style.display = 'flex';
            document.getElementById('customModalSearch').focus();
            // store all for filtering
            window._customModalData = { items, callback, type };
        }

        function fillCustomModalTable(type, items, callback) {
            const thead = document.querySelector("#customModalTable thead");
            const tbody = document.querySelector("#customModalTable tbody");
            tbody.innerHTML = "";
            if (type === "User") {
                thead.innerHTML = `<tr><th>Status</th><th>Name</th><th>Role</th><th>Action</th></tr>`;
                items.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                            <td><span class="${user.IsOnline ? 'online-dot' : 'offline-dot'}" title="${user.IsOnline ? 'Online' : 'Offline'}"></span></td>
                            <td>${user.Name}</td>
                            <td>${user.Role}</td>
                            <td><button class="start-chat-btn" onclick="event.stopPropagation();window._customModalData.callback('${user.Id}')">Chat</button></td>
                        `;
                    tbody.appendChild(tr);
                });
            } else if (type === "Issue") {
                thead.innerHTML = `<tr><th>Title</th><th>Student</th><th>Status</th><th>Action</th></tr>`;
                items.forEach(i => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                            <td>${i.IssueTitle}</td>
                            <td>${i.StudentName ?? 'N/A'}</td>
                            <td>${i.IssueStatus ?? 'N/A'}</td>
                            <td><button class="link-btn" onclick="event.stopPropagation();window.linkIssue('${i.IssueId}')">Link</button></td>
                        `;
                    tbody.appendChild(tr);
                });
            } else if (type === "Meeting") {
                thead.innerHTML = `<tr><th>Title</th><th>Student</th><th>Date</th><th>Action</th></tr>`;
                items.forEach(m => {
                    const tr = document.createElement('tr');
                    const dt = m.Date ? new Date(m.Date) : null;
                    tr.innerHTML = `
                            <td>${m.Title ?? '(No title)'}</td>
                            <td>${m.StudentName ?? 'N/A'}</td>
                            <td>${dt ? dt.toLocaleDateString() : 'N/A'}</td>
                            <td><button class="link-btn" onclick="event.stopPropagation();window.linkMeeting('${m.MeetingId}')">Link</button></td>
                        `;
                    tbody.appendChild(tr);
                });
            }
        }

        function filterCustomModalTable() {
            if (!window._customModalData) return;
            const { items, callback, type } = window._customModalData;
            const searchTerm = document.getElementById('customModalSearch').value.toLowerCase();
            let filtered = items;
            if (type === "User") {
                const roleFilterVal = document.getElementById('customModalRoleFilter').value;
                filtered = items.filter(u => {
                    const nameMatch = u.Name.toLowerCase().includes(searchTerm);
                    const roleMatch = roleFilterVal === '' || u.Role === roleFilterVal;
                    return nameMatch && roleMatch;
                });
            } else if (type === "Issue") {
                filtered = items.filter(i =>
                    (i.IssueTitle && i.IssueTitle.toLowerCase().includes(searchTerm)) ||
                    (i.StudentName && i.StudentName.toLowerCase().includes(searchTerm))
                );
            } else if (type === "Meeting") {
                filtered = items.filter(m =>
                    (m.Title && m.Title.toLowerCase().includes(searchTerm)) ||
                    (m.StudentName && m.StudentName.toLowerCase().includes(searchTerm))
                );
            }
            fillCustomModalTable(type, filtered, callback);
        }

        // Modal action callbacks
        async function startConversation(userId) {
            const response = await fetch('/Message/StartConversation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `userId=${userId}`
            });
            const result = await response.json();
            closeCustomModal();
            loadInbox();
            openConversation(result.conversationId, result.name);
        }

        async function linkIssue(issueId) {
            const res = await fetch('/Message/SendIssueCardMessage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `conversationId=${currentConversationId}&issueId=${issueId}`
            });
            const data = await res.json();
            if (data.success) {
                closeCustomModal();
                openConversation(currentConversationId, document.getElementById('chatHeader').textContent);
            }
        }

        async function linkMeeting(meetingId) {
            const res = await fetch('/Message/SendMeetingCardMessage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `conversationId=${currentConversationId}&meetingId=${meetingId}`
            });
            const data = await res.json();
            if (data.success) {
                closeCustomModal();
                openConversation(currentConversationId, document.getElementById('chatHeader').textContent);
            }
        }

        // --- ARCHIVE/DELETE FUNCTION ---
        async function archiveConversation(event, convoId) {
            event.stopPropagation();
            Swal.fire({
                title: "Archive Conversation?",
                text: "Are you sure you want to move this conversation to your archive?",
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: "#7F3D98",
                cancelButtonColor: "#bbb",
                confirmButtonText: "Yes, archive it",
                background: "#fff"
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const response = await fetch('/Message/ArchiveConversation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `conversationId=${convoId}`
                    });
                    if (response.ok) {
                        loadInbox();
                        Swal.fire({
                            icon: "success",
                            title: "Conversation Archived",
                            timer: 1200,
                            showConfirmButton: false,
                            background: "#fff"
                        });
                    }
                }
            });
        }

        // --- SEND MESSAGE FUNCTION ---
        async function sendMessage() {
            const input = document.querySelector('.chat-footer input');
            const btn = document.querySelector('.chat-footer button[aria-label="Send message"]');
            if (input.disabled || btn.disabled) return;
            const content = input.value.trim();
            if (!content) return;
            btn.disabled = true;

            const res = await fetch('/Message/SendMessage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `conversationId=${currentConversationId}&content=${encodeURIComponent(content)}`
            });
            input.value = '';
            btn.disabled = false;
            // Reload current conversation messages
            openConversation(currentConversationId, document.getElementById('chatHeader').textContent);
        }
    </script>
}





