@{
    ViewBag.Title = "Messages";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />

<style>
    body {
        background: #f5f5fa;
    }

    .dm-container {
        max-width: 1400px;
        min-width: 900px;
        margin: 32px auto 0;
        height: 540px;
        border-radius: 14px;
        background: #f5f5fa;
        box-shadow: 0 4px 32px rgb(127 61 152 / 0.10);
        display: flex;
        overflow: hidden;
    }

    .inbox-pane {
        width: 36%;
        background: #fff;
        border-right: 1.5px solid #eee;
        display: flex;
        flex-direction: column;
        min-width: 320px;
    }

    .inbox-header {
        font-size: 1.23em;
        font-weight: 700;
        color: #7F3D98;
        background: #fff;
        border-bottom: 1px solid #eee;
        padding: 20px 30px 12px 30px;
        position: sticky;
        top: 0;
        z-index: 3;
    }

    .inbox-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 14px 26px 14px 26px;
        background: #fff;
        border-bottom: 1px solid #eee;
        position: sticky;
        top: 60px;
        z-index: 2;
    }

    #inboxSearch {
        flex-grow: 1;
        padding: 8px 16px;
        border: 1.2px solid #d4cbe5;
        border-radius: 8px;
        font-size: 1em;
        background: #faf6ff;
        color: #422759;
        outline: none;
        transition: border .2s;
    }

        #inboxSearch:focus {
            border: 1.7px solid #7F3D98;
        }

    #roleFilter {
        padding: 8px 10px;
        border: 1.2px solid #d4cbe5;
        border-radius: 8px;
        font-size: 1em;
        background: #faf6ff;
        color: #7F3D98;
        outline: none;
    }

    #newChatBtn {
        background: #7F3D98;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 24px;
        width: 44px;
        height: 44px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background .15s;
        box-shadow: 0 0 10px rgb(127 61 152 / 0.18);
    }

        #newChatBtn:hover {
            background: #642b7b;
        }

    #inboxList {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0 10px 0 10px;
        background: #fff;
    }

    .inbox-item {
        display: flex;
        flex-direction: column;
        padding: 13px 28px 11px 28px;
        border-bottom: 1px solid #f0f0f0;
        position: relative;
        cursor: pointer;
        user-select: none;
        transition: background 0.14s;
    }

        .inbox-item:hover {
            background: #f6edff;
        }

    .inbox-item-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0;
    }

    .inbox-meta {
        display: flex;
        align-items: center;
        min-width: 0;
    }

    .message-name {
        font-weight: 700;
        font-size: 1em;
        color: #7F3D98;
        margin-right: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 140px;
    }

        .message-name.unread {
            font-weight: 900;
        }

    .message-role {
        font-size: 0.84em;
        color: #9162b8;
        font-weight: 600;
        margin-right: 10px;
        white-space: nowrap;
    }

    .online-dot, .offline-dot {
        display: inline-block;
        width: 9px;
        height: 9px;
        border-radius: 50%;
        margin-right: 6px;
    }

    .online-dot {
        background: #28a745;
    }

    .offline-dot {
        background: #bababa;
    }

    .message-preview-date {
        display: flex;
        justify-content: space-between;
        font-size: 0.89em;
        color: #555;
        margin-top: 3px;
        gap: 12px;
    }

    .message-preview {
        flex-grow: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 220px;
    }

    .message-date {
        white-space: nowrap;
        color: #bbb;
    }

    .pin-icon {
        font-size: 16px;
        margin-left: 6px;
    }

    .options-icon {
        font-size: 21px;
        margin-left: 12px;
        cursor: pointer;
        background: none;
        border: none;
        color: #9672b6;
        opacity: 0;
        transition: opacity .18s;
        position: relative;
        z-index: 5;
        padding: 0;
    }

    .inbox-item:hover .options-icon {
        opacity: 1;
    }

    .options-menu {
        display: none;
        position: absolute;
        right: 25px;
        bottom: 8px;
        background: #fff;
        border: 1.2px solid #d1c1e0;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(127,61,152,0.09);
        min-width: 130px;
        z-index: 30;
        overflow: hidden;
        transition: opacity .12s;
    }

        .options-menu.show {
            display: block;
        }

        .options-menu div {
            padding: 10px 18px 9px 18px;
            font-size: 1em;
            cursor: pointer;
            color: #7F3D98;
            background: none;
            border: none;
            text-align: left;
            font-weight: 600;
            transition: background .13s;
        }

            .options-menu div:hover {
                background: #f4eaff;
                color: #511a75;
            }

    /* Chat pane */
    .chat-pane {
        width: 64%;
        display: flex;
        flex-direction: column;
        background: #f5f5fa;
        border-left: 1.5px solid #eee;
        min-width: 420px;
    }

    .chat-header {
        padding: 20px 36px 14px 36px;
        border-bottom: 1px solid #eee;
        font-size: 1.08em;
        font-weight: 700;
        background: #fafafa;
        color: #7F3D98;
        display: flex;
        align-items: center;
    }

        .chat-header .status-label {
            margin-left: 8px;
            font-weight: 600;
            font-size: 0.96em;
        }

    .chat-body {
        flex-grow: 1;
        padding: 20px 36px 16px 36px;
        overflow-y: auto;
        background: #fcfbfe;
        font-size: 1em;
    }

    .chat-footer {
        padding: 15px 36px 13px 36px;
        border-top: 1px solid #eee;
        display: flex;
        background: #fafafa;
    }

        .chat-footer input {
            flex-grow: 1;
            padding: 10px 18px;
            border-radius: 22px;
            border: 1.5px solid #bda9da;
            outline: none;
            font-size: 1em;
            background: #fff;
            color: #333;
            margin-right: 12px;
        }

        .chat-footer button {
            background: #7F3D98;
            border: none;
            color: white;
            padding: 10px 24px;
            border-radius: 24px;
            font-weight: 700;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 0 8px rgb(127 61 152 / 0.1);
            margin-right: 8px;
            transition: background .2s;
        }

            .chat-footer button:disabled {
                opacity: .45;
            }

            .chat-footer button:hover:not(:disabled) {
                background: #642b7b;
            }
    /* Paperclip */
    #linkDropdownBtn {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2em;
        background: #7F3D98;
        margin-right: 0;
        color: #fff;
        border: none;
        transition: background .2s;
    }

        #linkDropdownBtn:disabled {
            opacity: .45;
        }

        #linkDropdownBtn:hover:not(:disabled) {
            background: #642b7b;
        }

    /* Message bubbles */
    .chat-message {
        display: flex;
        margin-bottom: 9px;
        user-select: text;
        font-size: 1em;
        line-height: 1.32;
    }

        .chat-message.mine {
            justify-content: flex-end;
        }

        .chat-message.theirs {
            justify-content: flex-start;
        }

    .msg-bubble {
        max-width: 62%;
        padding: 9px 14px;
        border-radius: 14px;
        background: #eee;
        box-shadow: 0 1px 3px rgb(127 61 152 / 0.07);
        word-break: break-word;
        font-size: 1em;
        line-height: 1.35;
    }

    .chat-message.mine .msg-bubble {
        background: #7F3D98;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .chat-message.theirs .msg-bubble {
        background: #f0f0f0;
        color: #222;
        border-bottom-left-radius: 4px;
    }

    .msg-name {
        font-weight: 700;
        font-size: 0.82em;
        margin-bottom: 4px;
    }

    .msg-time {
        font-size: 0.70em;
        color: #b3a2c3;
        text-align: right;
        margin-top: 6px;
    }

    /* New Chat Modal */
    #newChatModal .modal-content {
        width: 860px !important;
    max-height: 68vh !important;
        padding: 24px 32px 32px 32px !important;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 12px 40px #9f8db852;
        border: 2.2px solid #e4d8fa;
    }

    #newChatModal {
        display: none;
        position: fixed;
        z-index: 1200;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        background: rgba(127,61,152,0.07);
        justify-content: center;
        align-items: center;
    }

        #newChatModal.show {
            display: flex;
        }

    #newChatSearch, #newChatRoleFilter {
        width: 45%;
        margin-right: 10px;
        padding: 8px 14px;
        border: 1.2px solid #e2d0fa;
        border-radius: 9px;
        background: #fcfbfe;
        color: #542b7a;
        font-size: 1em;
    }

        #newChatSearch:focus, #newChatRoleFilter:focus {
            border: 1.7px solid #7F3D98;
        }

    #newChatUserTable {
        width: 100%;
        border-collapse: collapse;
        margin-top: 14px;
        background: #fff;
        font-size: 1em;
    }

        #newChatUserTable th, #newChatUserTable td {
            padding: 11px 10px;
            text-align: left;
            border-bottom: 1px solid #ede4fb;
            vertical-align: middle;
        }

        #newChatUserTable th {
            background: #f5f5fa;
            color: #7F3D98;
            font-weight: 700;
            font-size: 1em;
        }

        #newChatUserTable tr:hover {
            background: #f9f5fd;
            cursor: pointer;
        }

    .start-chat-btn {
        background: #7F3D98;
        border: none;
        color: white;
        padding: 6px 16px;
        border-radius: 18px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1em;
        transition: background-color 0.22s;
        box-shadow: 0 1px 4px #e7d0fa34;
    }

        .start-chat-btn:hover {
            background: #642b7b;
        }

    .close-modal-btn {
        background: #f1e5ff;
        border: none;
        color: #7F3D98;
        padding: 6px 18px;
        border-radius: 18px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1em;
        margin-top: 14px;
    }

        .close-modal-btn:hover {
            background: #ede1fa;
        }
</style>

<div class="dm-container" role="main" aria-label="Messages Interface">
    <section class="inbox-pane" id="inboxPane" aria-label="Message Inbox">
        <header class="inbox-header">Message Inbox</header>
        <div class="inbox-controls">
            <input type="search" id="inboxSearch" placeholder="Search conversations..." aria-label="Search conversations" oninput="applyInboxFilters()" />
            <select id="roleFilter" aria-label="Filter conversations by role" onchange="applyInboxFilters()"><option value="">All Roles</option></select>
            <button id="newChatBtn" title="New Chat" aria-haspopup="dialog" aria-expanded="false">+</button>
        </div>
        <div id="inboxList" tabindex="0" aria-live="polite" aria-relevant="additions"></div>
    </section>
    <section class="chat-pane" aria-label="Chat window">
        <header class="chat-header" id="chatHeader" tabindex="0">No conversation selected</header>
        <section class="chat-body" id="chatBody" tabindex="0" aria-live="polite" aria-relevant="additions">
            <div class="chat-placeholder">Select a conversation to begin</div>
        </section>
        <footer class="chat-footer">
            <input type="text" placeholder="Type a message..." aria-label="Message input" disabled />
            <button aria-label="Send message" disabled>Send</button>
            <button id="linkDropdownBtn" title="Link message" aria-haspopup="menu" aria-expanded="false" disabled>📎</button>
        </footer>
    </section>
</div>

<!-- New Chat Modal -->
<div id="newChatModal">
    <div class="modal-content" role="document">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2 style="color:#7F3D98; margin-bottom: 7px;">Start New Chat</h2>
            <button onclick="closeNewChatModal()" class="close-modal-btn" style="margin-top:0;margin-bottom:0;padding:6px 14px;">Close</button>
        </div>
        <div style="margin-bottom:8px;">
            <input type="search" id="newChatSearch" placeholder="Search users..." aria-label="Search users" oninput="filterNewChatUsers()" />
            <select id="newChatRoleFilter" aria-label="Filter by role" onchange="filterNewChatUsers()">
                <option value="">All Roles</option>
            </select>
        </div>
        <table id="newChatUserTable" aria-label="Available users for new chat">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Name</th>
                    <th>Role</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let fullInbox = [], fullUsers = [], currentConversationId = null;

        document.addEventListener("DOMContentLoaded", function () {
            loadInbox();

            document.getElementById('newChatBtn').addEventListener('click', openNewChatModal);
            document.getElementById('linkDropdownBtn').addEventListener('click', toggleLinkDropdown);

            document.querySelector('.chat-footer button[aria-label="Send message"]').addEventListener('click', sendMessage);
            document.querySelector('.chat-footer input').addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

            document.addEventListener('click', function (e) {
                if (!e.target.closest('.options-icon') && !e.target.closest('.options-menu')) closeAllOptionsMenus();
            });
        });

        async function loadInbox() {
            const res = await fetch('/Message/Inbox');
            const data = await res.json();
            fullInbox = data.conversations;
            populateRoleFilter(data.roles);
            renderInbox(fullInbox);
        }
        function populateRoleFilter(roles) {
            const roleSelect = document.getElementById('roleFilter');
            roleSelect.innerHTML = '<option value="">All Roles</option>';
            roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role;
                option.textContent = role;
                roleSelect.appendChild(option);
            });
        }
        function applyInboxFilters() {
            const searchTerm = document.getElementById('inboxSearch').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            const filtered = fullInbox.filter(convo => {
                const matchName = convo.Name.toLowerCase().includes(searchTerm);
                const matchRole = roleFilter === '' || convo.Role === roleFilter;
                return matchName && matchRole;
            });
            renderInbox(filtered);
        }
        function renderInbox(conversations) {
            const list = document.getElementById('inboxList');
            list.innerHTML = '';
            if (conversations.length === 0) {
                list.innerHTML = '<p style="padding: 20px; color:#888;">No conversations found.</p>';
                return;
            }
            conversations.forEach(convo => {
                const div = document.createElement('div');
                div.classList.add('inbox-item');
                div.dataset.convoId = convo.Id;
                div.onclick = () => openConversation(convo.Id, convo.Name);

                const isUnread = convo.UnreadCount > 0;

                div.innerHTML = `
                    <div class="inbox-item-top">
                        <div class="inbox-meta">
                            <span class="message-name ${isUnread ? 'unread' : ''}">${convo.Name}</span>
                            <span class="message-role">${convo.Role}</span>
                            <span class="${convo.IsOnline ? 'online-dot' : 'offline-dot'}" title="${convo.IsOnline ? 'Online' : 'Offline'}"></span>
                        </div>
                        <div style="position:relative;">
                            ${convo.IsPinned ? '<span class="pin-icon" title="Pinned">📌</span>' : ''}
                            <span class="options-icon" onclick="event.stopPropagation();toggleOptionsMenu(event, ${convo.Id})">⋮</span>
                            <div class="options-menu" id="options-menu-${convo.Id}">
                                <div onclick="event.stopPropagation();togglePin(event, ${convo.Id})">${convo.IsPinned ? 'Unpin Chat' : 'Pin Chat'}</div>
                                <div onclick="event.stopPropagation();archiveConversation(event, ${convo.Id})">Archive Conversation</div>
                            </div>
                        </div>
                    </div>
                    <div class="message-preview-date">
                        <span class="message-preview">${convo.LastMessage ?? '(No messages yet)'}</span>
                        <span class="message-date">${formatDate(convo.UpdatedAt)}</span>
                    </div>`;
                list.appendChild(div);
            });
        }
        function toggleOptionsMenu(e, convoId) {
            e.stopPropagation();
            closeAllOptionsMenus();
            const menu = document.getElementById(`options-menu-${convoId}`);
            if (menu) menu.classList.toggle('show');
        }
        function closeAllOptionsMenus() {
            document.querySelectorAll('.options-menu.show').forEach(menu => menu.classList.remove('show'));
        }
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date)) return '';
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) + ' ' + date.toLocaleDateString();
        }
        async function openConversation(id, name) {
            currentConversationId = id;
            const res = await fetch(`/Message/GetMessages?conversationId=${id}`);
            const data = await res.json();
            const header = document.getElementById('chatHeader');
            header.innerHTML = `
                <span class="${data.IsOnline ? 'online-dot' : 'offline-dot'}"></span>
                ${name}
                <span class="status-label">${data.IsOnline ? 'Online' : 'Offline'}</span>`;
            const chatBody = document.getElementById('chatBody');
            chatBody.innerHTML = '';
            data.Messages.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.classList.add('chat-message', msg.IsMine ? 'mine' : 'theirs');
                let contentHtml = '';
                if (msg.Content.includes('mini-issue-card') || msg.Content.includes('mini-meeting-card')) {
                    contentHtml = msg.Content;
                } else {
                    contentHtml = `
                        <div class="msg-name">${msg.SenderName}</div>
                        <div class="msg-content">${msg.Content}</div>
                        <div class="msg-time">${formatDate(msg.SentAt)}</div>`;
                }
                msgDiv.innerHTML = `<div class="msg-bubble">${contentHtml}</div>`;
                chatBody.appendChild(msgDiv);
            });
            chatBody.scrollTop = chatBody.scrollHeight;
            document.querySelector('.chat-footer input').disabled = false;
            document.querySelector('.chat-footer button[aria-label="Send message"]').disabled = false;
            document.getElementById('linkDropdownBtn').disabled = false;

            fetch('/Message/MarkAllAsRead', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `conversationId=${id}`
            }).then(() => loadInbox());
        }
        async function sendMessage() {
            const input = document.querySelector('.chat-footer input');
            const content = input.value.trim();
            if (!content || !currentConversationId) return;
            const res = await fetch('/Message/SendMessage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `conversationId=${encodeURIComponent(currentConversationId)}&content=${encodeURIComponent(content)}`
            });
            const data = await res.json();
            if (data.success) {
                input.value = '';
                openConversation(currentConversationId, document.getElementById('chatHeader').textContent.trim());
            }
        }
        async function togglePin(e, convoId) {
            e.stopPropagation();
            const res = await fetch('/Message/TogglePin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `conversationId=${convoId}`
            });
            const data = await res.json();
            if (data.success) loadInbox();
        }
        async function archiveConversation(e, convoId) {
            e.stopPropagation();
            const confirmed = await Swal.fire({
                icon: 'warning',
                title: 'Archive this conversation?',
                showCancelButton: true,
                confirmButtonText: 'Yes',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#7F3D98',
                customClass: { popup: 'swal2-theme-purple' }
            });
            if (!confirmed.isConfirmed) return;
            const res = await fetch('/Message/ArchiveConversation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `conversationId=${convoId}`
            });
            const data = await res.json();
            if (data.success) {
                if (currentConversationId === convoId) {
                    currentConversationId = null;
                    document.getElementById('chatHeader').textContent = 'No conversation selected';
                    document.getElementById('chatBody').innerHTML = '<div class="chat-placeholder">Select a conversation to begin</div>';
                    document.querySelector('.chat-footer input').disabled = true;
                    document.querySelector('.chat-footer button[aria-label="Send message"]').disabled = true;
                    document.getElementById('linkDropdownBtn').disabled = true;
                }
                loadInbox();
            } else {
                Swal.fire({ icon: 'error', title: 'Failed to archive conversation.', customClass: { popup: 'swal2-theme-purple' } });
            }
        }

        // ---------- NEW CHAT MODAL ----------
        async function openNewChatModal() {
            const res = await fetch('/Message/GetAvailableUsers');
            fullUsers = await res.json();
            const roleFilter = document.getElementById('newChatRoleFilter');
            roleFilter.innerHTML = '<option value="">All Roles</option>';
            [...new Set(fullUsers.map(u => u.Role))].forEach(role => {
                const option = document.createElement('option');
                option.value = role;
                option.textContent = role;
                roleFilter.appendChild(option);
            });
            renderNewChatUserTable(fullUsers);
            document.getElementById('newChatModal').classList.add('show');
            document.getElementById('newChatSearch').value = '';
            document.getElementById('newChatRoleFilter').value = '';
            document.getElementById('newChatSearch').focus();
        }
        function closeNewChatModal() {
            document.getElementById('newChatModal').classList.remove('show');
        }
        function renderNewChatUserTable(users) {
            const tbody = document.querySelector('#newChatUserTable tbody');
            tbody.innerHTML = '';
            users.forEach(user => {
                const tr = document.createElement('tr');
                const statusTd = document.createElement('td');
                const dot = document.createElement('span');
                dot.className = user.IsOnline ? 'online-dot' : 'offline-dot';
                dot.title = user.IsOnline ? 'Online' : 'Offline';
                statusTd.appendChild(dot); tr.appendChild(statusTd);
                const nameTd = document.createElement('td');
                nameTd.textContent = user.Name; tr.appendChild(nameTd);
                const roleTd = document.createElement('td');
                roleTd.textContent = user.Role; tr.appendChild(roleTd);
                const actionTd = document.createElement('td');
                const btn = document.createElement('button');
                btn.className = 'start-chat-btn'; btn.textContent = 'Chat';
                btn.onclick = async (e) => { e.stopPropagation(); await startConversation(user.Id); };
                actionTd.appendChild(btn); tr.appendChild(actionTd);
                tbody.appendChild(tr);
            });
        }
        function filterNewChatUsers() {
            const searchTerm = document.getElementById('newChatSearch').value.toLowerCase();
            const roleFilterVal = document.getElementById('newChatRoleFilter').value;
            const filtered = fullUsers.filter(u => {
                const nameMatch = u.Name.toLowerCase().includes(searchTerm);
                const roleMatch = roleFilterVal === '' || u.Role === roleFilterVal;
                return nameMatch && roleMatch;
            });
            renderNewChatUserTable(filtered);
        }
        async function startConversation(userId) {
            const response = await fetch('/Message/StartConversation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `userId=${userId}`
            });
            const result = await response.json();
            closeNewChatModal();
            loadInbox();
            openConversation(result.conversationId, result.name);
        }
        // ---------- LINK ISSUE/MEETING ----------
        async function toggleLinkDropdown() {
            if (!currentConversationId) {
                Swal.fire({
                    icon: 'info',
                    text: 'Select a conversation first.',
                    customClass: { popup: 'swal2-theme-purple' }
                }); return;
            }
            const { value: linkType } = await Swal.fire({
                title: 'Link Message',
                input: 'select',
                inputOptions: { issue: 'Link Issue', meeting: 'Link Meeting' },
                inputPlaceholder: 'Select link type',
                showCancelButton: true,
                confirmButtonText: 'Proceed',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#7F3D98',
                width: '350px',
                customClass: { popup: 'swal2-theme-purple' }
            });
            if (linkType === 'issue') openLinkIssueModal();
            else if (linkType === 'meeting') openLinkMeetingModal();
        }
        async function openLinkIssueModal() {
            const res = await fetch('/Issue/GetUserIssues');
            const fullIssues = await res.json();
            const inputOptions = fullIssues.reduce((opts, i) => {
                opts[i.IssueId] = `${i.IssueTitle} (Student: ${i.StudentName ?? 'N/A'})`;
                return opts;
            }, {});
            const { value: issueId } = await Swal.fire({
                title: 'Select Issue to Link',
                input: 'select',
                inputOptions,
                inputPlaceholder: 'Select an issue',
                showCancelButton: true,
                confirmButtonText: 'Link',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#7F3D98',
                width: '400px',
                customClass: { popup: 'swal2-theme-purple' }
            });
            if (issueId) {
                const res = await fetch('/Message/SendIssueCardMessage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `conversationId=${currentConversationId}&issueId=${issueId}`
                });
                const data = await res.json();
                if (data.success) {
                    openConversation(currentConversationId, document.getElementById('chatHeader').textContent);
                }
            }
        }
        async function openLinkMeetingModal() {
            const res = await fetch('/Meeting/GetUserMeetings');
            const fullMeetings = await res.json();
            const inputOptions = fullMeetings.reduce((opts, m) => {
                opts[m.MeetingId] = `${m.Title} (Student: ${m.StudentName ?? 'N/A'}) - ${new Date(m.Date).toLocaleDateString()}`;
                return opts;
            }, {});
            const { value: meetingId } = await Swal.fire({
                title: 'Select Meeting to Link',
                input: 'select',
                inputOptions,
                inputPlaceholder: 'Select a meeting',
                showCancelButton: true,
                confirmButtonText: 'Link',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#7F3D98',
                width: '400px',
                customClass: { popup: 'swal2-theme-purple' }
            });
            if (meetingId) {
                const res = await fetch('/Message/SendMeetingCardMessage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `conversationId=${currentConversationId}&meetingId=${meetingId}`
                });
                const data = await res.json();
                if (data.success) {
                    openConversation(currentConversationId, document.getElementById('chatHeader').textContent);
                }
            }
        }
    </script>
}
