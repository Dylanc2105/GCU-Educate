@{
    ViewBag.Title = "Messages";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="dm-wrapper">
    <!-- LEFT PANE: INBOX -->
    <div class="inbox-pane" id="inboxList">
        <div class="inbox-header">
            <div class="inbox-controls">
                <input type="text" id="inboxSearch" class="conversation-search" placeholder="Search messages..." onkeyup="applyInboxFilters()">
                <button class="filter-icon-btn" onclick="toggleInboxFilterDropdown()"><span></span></button>
                <button class="new-chat-btn" onclick="openNewChatModal()">+ New Chat</button>
                <button class="gear-style" onclick="openSettingsModal()" title="Settings">⚙️</button>
            </div>
            <div id="inboxRoleFilterDropdown" class="role-dropdown static-dropdown" style="display: none;"></div>
        </div>
        <div id="conversationContainer">
            <p class="text-center p-3">Loading conversations...</p>
        </div>
    </div>

    <!-- RIGHT PANE: CHAT -->
    <div class="chat-pane">
        <div class="chat-header" id="chatHeader" style="display: none;">
            <span id="chatName">Selected User</span>
            <span id="chatRole" class="chat-role-badge">Role</span>
        </div>
        <div class="chat-messages" id="messageList">
            <p class="text-center text-muted">Select a conversation to start chatting</p>
        </div>
        <div class="chat-input message-box" data-conversation-id="" style="display: none;">
            <textarea id="messageText" placeholder="Type a message..."></textarea>
            <button id="sendBtn" onclick="sendMessage()">Send</button>
            <div class="attachment-wrapper">
                <button class="attachment-btn" onclick="toggleAttachmentMenu()" title="More actions">📎</button>
                <div class="attachment-menu" id="attachmentMenu" style="display: none;">
                    <button onclick="openLinkIssueModal()">🔗 Link Issue</button>
                    <button onclick="linkMeeting()">📅 Link Meeting</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 🔗 Link Issue Modal -->
<div id="linkIssueModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Link an Issue</h3>
            <button class="close-btn" onclick="closeLinkIssueModal()">×</button>
        </div>
        <input type="text" id="issueSearch" placeholder="Search issues..." onkeyup="filterIssueResults()">
        <div id="issueResultList">
            <p>Loading issues...</p>
        </div>
    </div>
</div>

<!-- 💬 New Chat Modal -->
<div id="newChatModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Start New Chat</h3>
            <button class="close-btn" onclick="closeNewChatModal()">×</button>
        </div>
        <input type="text" id="userSearch" placeholder="Search users..." onkeyup="filterUserList()">
        <div id="roleFilterDropdown" class="role-dropdown" style="display: none;"></div>
        <div id="userList" class="user-list">
            <p>Loading users...</p>
        </div>
    </div>
</div>

<!-- View Archived Conversations Modal -->
<div id="archivedModal" class="modal-overlay" style="display: none;">
    <div class="modal-content wide-settings">
        <div class="modal-header">
            <h3>Archived Conversations</h3>
            <button class="close-btn" onclick="$('#archivedModal').hide();">×</button>
        </div>
        <div id="archivedList">
            <p>Loading archived conversations...</p>
        </div>
    </div>
</div>

<!--  Confurm Archived Conversations  -->
<div id="confirmArchiveModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>Confirm Archive</h3>
            <button class="close-btn" onclick="closeConfirmArchiveModal()">×</button>
        </div>
        <p id="confirmArchiveText">Are you sure you want to archive this conversation?</p>
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button class="setting-btn" onclick="confirmArchive()">Yes, Archive</button>
            <button class="setting-btn" onclick="closeConfirmArchiveModal()">Cancel</button>
        </div>
    </div>
</div>


<!-- ⚙️ Settings Modal -->
<div id="settingsModal" class="modal-overlay" style="display:none;">
    <div class="modal-content wide-settings">
        <div class="modal-header">
            <h3>Message Settings</h3>
            <button class="close-btn" onclick="closeSettingsModal()">×</button>
        </div>

        <!-- Archive Section -->
        <div class="setting-section">
            <h4 class="section-title">Archive</h4>
            <div class="setting-row">
                <span>Archive all messages</span>
                <button class="setting-btn" onclick="showArchiveConfirmation('all')">Archive</button>
            </div>
            <div class="setting-row">
                <span>View archived conversations</span>
                <button class="setting-btn" onclick="openArchivedModal()">View all</button>
            </div>
        </div>

        <!-- Notifications Section -->
        <div class="setting-section">
            <h4 class="section-title">Notifications</h4>
            <div class="setting-row">
                <span>Disable all notifications</span>
                <label class="toggle-label">
                    <input type="checkbox" />
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-row">
                <span>Disable student notifications</span>
                <label class="toggle-label">
                    <input type="checkbox" />
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- Read Receipts Section -->
        <div class="setting-section">
            <h4 class="section-title">Read Receipts</h4>
            <div class="setting-row">
                <span>Mark all messages as read</span>
                <button class="setting-btn" onclick="markAllAsRead()">Mark as Read</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Layout & Pane Styles */
    .dm-wrapper {
        height: 90vh;
        display: flex;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        background: #fff;
        border: 1px solid #ddd;
        overflow: hidden;
    }

    .input-wrapper {
        position: relative;
        flex-grow: 1;
        display: flex;
        align-items: center;
    }

        .input-wrapper textarea {
            width: 100%;
            min-height: 40px;
            padding: 12px 40px 12px 16px;
            border-radius: 20px;
            border: 1px solid #ccc;
            font-size: 14px;
            resize: none;
        }

    .inbox-pane {
        width: 35%;
        display: flex;
        flex-direction: column;
        background: #f4f4f4;
        border-right: 1px solid #ddd;
    }

    #conversationContainer {
        flex-grow: 1;
        overflow-y: auto;
    }


    .chat-pane {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
        border-radius: 0 10px 10px 0;
    }

    /* Chat Header */
    .chat-header {
        background-color: #7F3D98;
        color: white;
        padding: 16px;
        font-size: 16px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-radius: 10px 10px 0 0;
        flex-shrink: 0; /* ensure it doesn’t collapse */
    }

        .chat-header .chat-role-badge {
            background-color: rgba(255, 255, 255, 0.15);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

    /* Settings Area */
    .archived-header {
        background: #999 !important;
        opacity: 0.9;
    }

    /* Make modal wider */
    .wide-settings {
        width: 900px;
    }

    /* Section spacing */
    .setting-section {
        margin-bottom: 30px;
    }

    /* Section titles */
    .section-title {
        color: #7F3D98;
        font-size: 18px;
        margin-bottom: 10px;
    }

    /* Rows: label on left, control on right */
    .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 8px 0;
        font-size: 14px;
        color: #333;
    }

    .gear-style {
        background: none;
        border: none;
        font-size: 20px;
        color: #7F3D98;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
    }

        .gear-style:focus {
            outline: none;
            box-shadow: none;
        }

    .setting-btn {
        background-color: #7F3D98;
        border: none;
        font-size: 14px;
        color: white;
        padding: 8px 14px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
    }

        .setting-btn:hover {
            background-color: #985BAF;
        }

        .setting-btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(127, 61, 152, 0.4);
        }

    .conversation-item {
        padding: 15px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        flex-direction: column;
        position: relative; /* Needed for archive icon */
    }

        .conversation-item .archive-icon {
            position: absolute;
            bottom: 8px;
            right: 8px;
            font-size: 14px;
            color: #7F3D98;
            cursor: pointer;
            transition: color 0.2s;
        }

            .conversation-item .archive-icon:hover {
                color: #985BAF;
            }
    /* Toggle switch */
    .toggle-label {
        position: relative;
        display: inline-block;
        width: 60px;
        margin: 10px 0;
        padding-left: 70px;
        font-size: 14px;
        color: #333;
        cursor: pointer;
    }

        .toggle-label input {
            display: none;
        }

    .slider {
        position: absolute;
        top: 3px;
        left: 0;
        height: 20px;
        width: 40px;
        background: #ccc;
        border-radius: 20px;
        transition: 0.3s;
    }

        .slider::before {
            content: "";
            position: absolute;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: 0.3s;
        }

    .toggle-label input:checked + .slider {
        background: #7F3D98;
    }

        .toggle-label input:checked + .slider::before {
            transform: translateX(20px);
        }


    /* Message Area */
    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 16px;
        padding-bottom: 60px;
        display: flex;
        flex-direction: column;
    }

    .message-bubble {
        max-width: 70%;
        padding: 10px 15px;
        margin-bottom: 10px;
        border-radius: 15px;
        position: relative;
        clear: both;
        word-wrap: break-word;
        transition: background 0.2s ease-in-out;
    }

        .message-bubble.mine {
            background: #7F3D98;
            color: white;
            margin-left: auto;
        }



        .message-bubble.their {
            background: #e6e6e6;
            color: #111;
            margin-right: auto;
        }

    .message-meta {
        font-size: 10px;
        margin-top: 4px;
        color: #888;
    }

    .message-bubble.mine .message-meta {
        color: rgba(255, 255, 255, 0.6); /* toned-down white */
    }

    /* Chat Input Area */
    .chat-input {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        border-top: 1px solid #ddd;
        background: #fff;
        gap: 10px;
    }

        .chat-input.message-box {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-top: 1px solid #ddd;
            background: #fff;
            gap: 10px;
        }

        .chat-input textarea {
            flex-grow: 1;
            padding: 12px;
            border-radius: 20px;
            border: 1px solid #ccc;
            resize: none;
            font-size: 14px;
            min-height: 40px;
        }

        .chat-input #sendBtn {
            background: #7F3D98;
            color: white;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
        }

    #sendBtn {
        background: #7F3D98;
        color: white;
        border: none;
        padding: 10px 16px;
        font-size: 14px;
        border-radius: 8px;
        cursor: pointer;
    }

    .chat-input #sendBtn:hover {
        background: #985BAF;
    }

    .chat-input button {
        padding: 10px 18px;
        font-size: 14px;
    }

    .attachment-btn {
        background: none;
        border: none;
        font-size: 24px;
        color: #7F3D98;
        cursor: pointer;
    }


    .attachment-wrapper {
        position: relative;
    }



    /*  Inbox Pane */
    .inbox-pane {
        width: 35%;
        background: #f4f4f4;
        border-right: 1px solid #ddd;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .inbox-header {
        background: #f4f4f4;
        border-bottom: 1px solid #ddd;
        text-align: center;
    }

    /*  Inbox Controls – Search & Buttons */
    .conversation-search {
        padding: 10px 15px;
        border: 1px solid #ccc;
        border-radius: 20px;
        font-size: 14px;
        width: 60%;
        outline: none;
        margin-right: 10px;
    }

    .new-chat-btn {
        background: #7F3D98;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 14px;
    }

    .filter-icon-btn {
        background: none;
        border: none;
        position: relative;
        width: 22px;
        height: 22px;
        margin-left: 5px;
        cursor: pointer;
        color: #7F3D98;
    }

        .filter-icon-btn::before,
        .filter-icon-btn::after,
        .filter-icon-btn span {
            content: '';
            position: absolute;
            height: 3px;
            background: #7F3D98;
            left: 0;
            border-radius: 3px;
        }

        .filter-icon-btn::before {
            top: 2px;
            width: 20px;
        }

        .filter-icon-btn span {
            top: 9px;
            width: 16px;
        }

        .filter-icon-btn::after {
            top: 16px;
            width: 12px;
        }

    .role-dropdown.static-dropdown {
        position: static !important;
        margin: 0 16px 10px 16px;
        box-shadow: none;
        border: 1px solid #ccc;
        display: none;
    }

    /* Conversation Items */

    .conversation-item {
        padding: 15px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        flex-direction: column;
    }

        .conversation-item:hover {
            background: #e9e9e9;
        }

        .conversation-item.unread strong {
            font-weight: bold;
            color: #7F3D98;
        }

        .conversation-item .preview {
            color: #555;
            font-size: 14px;
        }

    .inbox-role-badge {
        display: inline-block;
        padding: 2px 10px;
        background: #7F3D98;
        color: white;
        font-size: 11px;
        font-weight: 500;
        border-radius: 12px;
        margin-top: 4px;
        width: fit-content;
        white-space: nowrap;
    }

    /*   Attachment Wrapper & Button */
    .attachment-wrapper {
        position: relative;
        margin-left: auto;
    }

    .attachment-btn {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #7F3D98;
        padding: 0 8px;
    }

    .attachment-menu {
        position: absolute;
        bottom: 120%;
        right: 0;
        background: white;
        border: 1px solid #ccc;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        display: none;
        flex-direction: column;
        min-width: 150px;
    }

        .attachment-menu button {
            background: none;
            border: none;
            text-align: left;
            padding: 10px 15px;
            width: 100%;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }

            .attachment-menu button:hover {
                background-color: #f0f0f0;
            }

    /*   Modal Overlay and Content */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: 10px;
        width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        padding: 20px;
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        gap: 10px;
    }

        .modal-header h3 {
            color: #7F3D98;
            font-size: 20px;
            margin: 0;
        }

        .modal-header select {
            font-size: 14px;
            padding: 5px;
            border-radius: 6px;
        }

        .modal-header .close-btn {
            background: none;
            border: none;
            font-size: 22px;
            color: #7F3D98;
            cursor: pointer;
            margin-left: auto;
        }

    .user-list div {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .user-list div:hover {
            background: #f0f0f0;
        }
    /*  Issue Search Field */
    #issueSearch {
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 20px;
        margin: 10px 0;
    }

    /* Linkable Issue Row (Flat Style) */
    .link-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 6px;
        border-bottom: 1px solid #eee;
        font-size: 14px;
    }

    .link-info {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .student-name {
        font-weight: 600;
        color: #333;
    }

    .issue-title {
        color: #555;
        font-size: 13px;
    }

    .issue-status {
        font-size: 13px;
        font-weight: 500;
        color: #7F3D98;
    }

    .link-btn {
        background-color: #7F3D98;
        color: white;
        border: none;
        border-radius: 16px;
        padding: 6px 14px;
        font-size: 13px;
        cursor: pointer;
    }

        .link-btn:hover {
            background-color: #985BAF;
        }

    /*  Mini Issue Card (Shown in Chat) */
    .mini-issue-card {
        border-left: 4px solid #7F3D98;
        background: #f9f9f9;
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 10px;
        font-size: 14px;
    }

    .mini-issue-header {
        display: flex;
        justify-content: space-between;
        font-weight: 600;
        color: #333;
    }

    .mini-date {
        font-size: 12px;
        color: #999;
    }

    .mini-status {
        margin-top: 4px;
        font-size: 13px;
        color: #7F3D98;
    }

    .mini-description {
        margin: 6px 0;
        color: #555;
    }

    .mini-actions {
        display: flex;
        gap: 10px;
        margin-top: 8px;
    }

    .mini-btn {
        background: #7F3D98;
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        transition: background 0.2s;
    }

        .mini-btn:hover {
            background: #985BAF;
        }

    /*  Static Role Dropdown (Inbox + New Chat) */
    .role-dropdown.static-dropdown {
        position: static !important;
        margin: 0 16px 10px 16px;
        box-shadow: none;
        border: 1px solid #ccc;
        display: none;
    }

    /*  Dynamic Role Dropdown (Popup Style) */
    .role-dropdown {
        position: absolute;
        top: 30px;
        right: 0;
        background: white;
        border: 1px solid #ccc;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        display: none;
        padding: 10px 15px;
        z-index: 1000;
        width: 200px;
    }

        .role-dropdown label {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #7F3D98;
            margin-bottom: 8px;
        }

        .role-dropdown input[type="checkbox"] {
            margin-right: 8px;
        }

    /* Role Badges */
    .role-badge {
        font-size: 11px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 12px;
        color: white;
        margin-left: 8px;
    }

    .inbox-role-badge {
        display: inline-block;
        padding: 2px 10px;
        background: #7F3D98;
        color: white;
        font-size: 11px;
        font-weight: 500;
        border-radius: 12px;
        margin-top: 4px;
        width: fit-content;
        white-space: nowrap;
    }
</style>

@section scripts {

    <script>
        let currentConversationRole = null;
        let currentConversationId = null;
        let allowedRoles = [];
        let archiveTargetType = null;
        let archiveTargetId = null;

    $(document).ready(function () {
        loadInbox();
    });

        function formatUkTimestamp(isoString) {
            const date = new Date(isoString);
            const options = { day: '2-digit', month: 'short', year: 'numeric' };
            const time = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            const formattedDate = date.toLocaleDateString('en-GB', options);
            return `${formattedDate} at ${time}`;
        }
     function openSettingsModal() {
            $('#settingsModal').show();
        }
    function closeSettingsModal() {
            $('#settingsModal').hide();
        }


  function loadInbox() {
        $.get('@Url.Action("Inbox", "Message")', function (response) {
            const data = response.conversations;
            inboxRoleFilters = response.roles;
            let html = '';
            data.forEach(c => {
                html += `<div class="conversation-item ${c.UnreadCount > 0 ? 'unread' : ''}"
                    data-name="${c.Name.toLowerCase()}" data-role="${c.Role.toLowerCase()}"
                    onclick="loadMessages(${c.Id}, '${c.Name.replace("'", "\\'")}', '${c.Role}')">
                    <strong>${c.Name}</strong>
                    <span class="inbox-role-badge">${c.Role}</span>
                    <div class="preview">${c.LastMessage || 'No messages yet'}</div>
                    ${c.UnreadCount > 0 ? `<div class="message-meta">${c.UnreadCount} unread</div>` : ''}
                    <span class="archive-icon" title="Archive" onclick="event.stopPropagation(); showArchiveConfirmation('single', ${c.Id})">🗃️</span>
                </div>`;
            });
            $('#conversationContainer').html(html || '<p class="text-center text-muted">No conversations yet.</p>');
            renderInboxRoleDropdown();
            applyInboxFilters();
        });
    }

        function clearChatView() {
            $('#messageList').html('');
            $('#chatHeader').hide();
            $('.chat-input').hide();
        }


        function loadMessages(convoId, name, role) {
            let isArchived = false;
    currentConversationId = convoId;
    currentConversationRole = role;

    // SET HEADER TEXT AND SHOW IT
    $('#chatName').text(name);
    $('#chatRole').text(role);
    $('#chatHeader').show();
    $('.chat-input').show();
    $('#messageList').html('<p class="text-center">Loading messages with ' + name + '...</p>');

    // Show/hide link buttons
    if (role === "Student") {
        $('[onclick="openLinkIssueModal()"]').hide();
        $('[onclick="linkMeeting()"]').show();
    } else {
        $('[onclick="openLinkIssueModal()"]').show();
        $('[onclick="linkMeeting()"]').show();
           }

    if (isArchived) {
         $('.chat-input').hide();
         $('#chatHeader').addClass('archived-header');
    } else {
         $('.chat-input').show();
         $('#chatHeader').removeClass('archived-header');
     }


    $.ajax({
        url: '@Url.Action("GetMessages", "Message")' + '?conversationId=' + convoId,
        method: 'GET',
        success: function (data) {
            const messages = data.Messages;
            if (!messages || messages.length === 0) {
                $('#messageList').html('<p class="text-center text-muted">No messages found.</p>');
                return;
            }

            messages.sort((a, b) => new Date(a.SentAt) - new Date(b.SentAt));
            let html = '';
            messages.forEach(msg => {
                html += `<div class="message-bubble ${msg.IsMine ? 'mine' : 'their'}">
                    ${msg.Content}
                    <div class="message-meta">
                        ${msg.SenderName} • ${formatUkTimestamp(msg.SentAt)}
                    </div>
                </div>`;
            });

            $('#messageList').html(html);
            scrollChatToBottom();
        },
        error: function () {
            $('#messageList').html('<p class="text-center text-danger">Failed to load messages.</p>');
        }
    });
}

        function toggleAttachmentMenu() {
            const menu = document.getElementById("attachmentMenu");
            menu.style.display = menu.style.display === "block" ? "none" : "block";
        }

        // Global click handler to close menu if clicked outside
        $(document).on('click', function (e) {
            if (!$(e.target).closest('.attachment-wrapper').length) {
                $('#attachmentMenu').hide();
            }
        });


        function linkMeeting() {
            $('#attachmentMenu').hide();
            alert('Link Meeting clicked – implement modal or redirect here.');
        }

    function scrollChatToBottom() {
        const chat = $('.chat-messages');
        chat.scrollTop(chat[0].scrollHeight);
    }

    function sendMessage() {
        const text = $('#messageText').val().trim();
        if (!text || currentConversationId === null) return;

        $.post('@Url.Action("SendMessage", "Message")', {
            conversationId: currentConversationId,
            content: text
        }, function () {
            $('#messageText').val('');
            loadMessages(currentConversationId);
            loadInbox();
        });
    }

    function openNewChatModal() {
        $('#newChatModal').show();
        loadAvailableUsers();
    }

    function closeNewChatModal() {
        $('#newChatModal').hide();
        $('#userSearch').val('');
        $('#userList').html('<p>Loading users...</p>');
    }

    function toggleRoleDropdown() {
        $('#roleFilterDropdown').toggle();
    }

    function loadAvailableUsers() {
        $.get('@Url.Action("GetAvailableUsers", "Message")', function (users) {
            const roleSet = new Set(users.map(u => u.Role));
            allowedRoles = Array.from(roleSet);
            renderRoleDropdown();

            const list = users.map(u =>
                `<div class="user-row" data-role="${u.Role.toLowerCase()}" onclick="startNewChat('${u.Id}')">
                    ${u.Name}
                    <div class="user-role">${u.Role}</div>
                </div>`
            ).join('');
            $('#userList').html(list || '<p>No users available</p>');
            filterByRoles();
        });
    }

    function renderRoleDropdown() {
        const container = $('#roleFilterDropdown');
        container.html('');
        allowedRoles.forEach(role => {
            const safeId = 'filter_' + role.replace(/\s/g, '');
            container.append(`
                <label><input type="checkbox" id="${safeId}" checked onchange="filterByRoles()"> ${role}</label>
            `);
        });
    }

    function filterByRoles() {
        const visibleRoles = [];
        $('#roleFilterDropdown input:checked').each(function () {
            visibleRoles.push($(this).parent().text().trim().toLowerCase());
        });

        $('#userList .user-row').each(function () {
            const role = $(this).data('role');
            $(this).toggle(visibleRoles.includes(role));
        });
    }

        function filterUserList() {
            const search = $('#userSearch').val().toLowerCase();
            $('#userList .user-row').each(function () {
                const name = $(this).contents().filter(function () {
                    return this.nodeType === 3; // Only text nodes
                }).text().toLowerCase();
                $(this).toggle(name.includes(search));
            });
        }


    function startNewChat(userId) {
        $.post('@Url.Action("StartConversation", "Message")', { userId }, function (data) {
            closeNewChatModal();
            loadInbox();
            loadMessages(data.conversationId, data.name);
        });
        }
        function openLinkIssueModal() {
            $('#linkIssueModal').show();
            $('#issueSearch').val('');
            loadLinkableIssues();
        }

        function closeLinkIssueModal() {
            $('#linkIssueModal').hide();
            $('#issueSearch').val('');
        }

        let allLinkableIssues = [];

        function loadLinkableIssues() {
            $.get('/Issue/GetLinkableIssues', function (data) {
                allLinkableIssues = data || [];
                renderIssueList();
            });
        }

        function renderIssueList() {
            const container = $('#issueResultList');
            if (!allLinkableIssues.length) {
                container.html('<p>No issues found.</p>');
                return;
            }

            const html = allLinkableIssues.map(i => `
        <div class="link-row">
            <div class="link-info">
                <span class="student-name">${i.StudentName}</span>
                <span class="dot">|</span>
                <span class="issue-status">${i.Status}</span>
                <span class="dot">|</span>
                <span class="issue-title">${i.Title}</span>
            </div>
            <button class="link-btn" onclick="sendIssueName(
                '${i.StudentName.replace(/'/g, "\\'")}',
                '${i.Title}',
                '${i.Status}',
                '${new Date(i.CreatedAt).toLocaleDateString()}',
                '${i.Description.replace(/'/g, "\\'")}',
                '${i.IssueId}',
                '${i.StudentId}'
            )">Link</button>
        </div>
    `).join('');

            container.html(html);
        }

        function markAllAsRead() {
            $.post('/Message/MarkAllAsRead')
                .done(() => {
                    loadInbox();
                })
                .fail(() => alert("Failed to mark messages as read."));
        }


        function archiveAllMessages() {
            $.post('/Message/ArchiveAllMessagesForCurrentUser', function () {
                alert("All your conversations have been archived.");
                loadInbox();
            }).fail(function () {
                alert("Failed to archive conversations.");
            });
        }

        function showArchiveConfirmation(type, convoId = null) {
            archiveTargetType = type;
            archiveTargetId = convoId;

            closeSettingsModal();

            const text = type === 'all'
                ? "Are you sure you want to archive all your conversations?"
                : "Are you sure you want to archive this conversation?";
            $('#confirmArchiveText').text(text);
            $('#confirmArchiveModal').show();
        }

        function closeConfirmArchiveModal() {
            $('#confirmArchiveModal').hide();
            archiveTargetType = null;
            archiveTargetId = null;
        }

        function confirmArchive() {
            if (archiveTargetType === 'single' && archiveTargetId !== null) {
                $.post('/Message/ArchiveConversation', { conversationId: archiveTargetId })
                    .done(() => loadInbox())
                    .fail(() => alert('Failed to archive conversation.'));
            } else if (archiveTargetType === 'all') {
                $.post('/Message/ArchiveAllMessagesForCurrentUser')
                    .done(() => loadInbox())
                    .fail(() => alert('Failed to archive all messages.'));
            }
            closeConfirmArchiveModal();
        }

        function loadArchivedConversations() {
            $.get('/Message/GetArchivedConversations', function (data) {
                if (!data || !data.length) {
                    $('#archivedList').html('<p class="text-muted">No archived chats.</p>');
                    return;
                }

                const html = data.map(c => `
            <div class="conversation-item" onclick="loadArchivedMessages(${c.Id}, '${c.Name.replace(/'/g, "\\'")}', '${c.Role}')">
                <strong>${c.Name}</strong>
                <span class="inbox-role-badge">${c.Role}</span>
                <div class="preview">${c.LastMessage}</div>
                <div class="message-meta">Archived on ${new Date(c.ArchivedAt).toLocaleDateString()}</div>
            </div>
        `).join('');

                $('#archivedList').html(html);
            });
        }


        function openArchivedModal() {
            closeSettingsModal();
            $('#archivedModal').show();
            loadArchivedConversations();
        }

        function loadArchivedMessages(convoId, name, role) {
            $('#archivedModal').hide(); //  Close modal when a chat is clicked
            clearChatView(); // Clear current view

            // Add 'archived-header' class for subtle styling
            $('#chatName').text(name + " (Archived Chat)");
            $('#chatName').text(name);
            $('#chatRole').text(role);
            $('#chatHeader').show().addClass('archived-header');
            $('#messageList').html('<p class="text-center">Loading archived messages with ' + name + '...</p>');

            $.get('/Message/GetMessages?conversationId=' + convoId, function (data) {
                const messages = data.Messages;
                if (!messages || messages.length === 0) {
                    $('#messageList').html('<p class="text-center text-muted">No messages found.</p>');
                    return;
                }

                let html = '';
                messages.forEach(msg => {
                    html += `<div class="message-bubble ${msg.IsMine ? 'mine' : 'their'}">
                        ${msg.Content}
                        <div class="message-meta">${msg.SenderName} • ${formatUkTimestamp(msg.SentAt)}</div>
                    </div>`;
                });

                $('#messageList').html(html);
                $('.chat-input').hide(); // ✅ Hide text input & buttons
                scrollChatToBottom();
            });
        }


      function sendIssueName(studentName, title, status, date, description, issueId, studentId) {
    $('#linkIssueModal').hide();

    $.post('/Message/SendIssueCardMessage', {
        conversationId: currentConversationId,
        issueId: issueId
    })
    .done(function () {
        loadMessages(currentConversationId);
        loadInbox();
    })
    .fail(function () {
        alert("Failed to send issue card.");
    });
}


        function filterIssueResults() {
            const search = $('#issueSearch').val().toLowerCase();
            const filtered = allLinkableIssues.filter(i =>
                i.StudentName.toLowerCase().includes(search) ||
                i.Title.toLowerCase().includes(search)
            );
            renderFilteredIssues(filtered);
        }

        function sortIssueResults() {
            const sort = $('#issueSortSelect').val();
            let sorted = [...allLinkableIssues];

            if (sort === 'date_asc') {
                sorted.sort((a, b) => new Date(a.CreatedAt) - new Date(b.CreatedAt));
            } else if (sort === 'date_desc') {
                sorted.sort((a, b) => new Date(b.CreatedAt) - new Date(a.CreatedAt));
            } else if (sort === 'status') {
                sorted.sort((a, b) => a.Status.localeCompare(b.Status));
            }

            renderFilteredIssues(sorted);
        }

        function renderFilteredIssues(data) {
            const container = $('#issueResultList');
            if (!data.length) {
                container.html('<p>No matching issues.</p>');
                return;
            }
                    const html = data.map(i => `
            <div class="link-row">
                <div class="link-info">
                    <span class="student-name">${i.StudentName}</span>
                    <span class="dot">|</span>
                    <span class="issue-status">${i.Status}</span>
                    <span class="dot">|</span>
                    <span class="issue-title">${i.Title}</span>
                </div>
                <button class="link-btn" onclick="sendIssueName(
                    '${i.StudentName.replace(/'/g, "\\'")}',
                    '${i.Title}',
                    '${i.Status}',
                    '${new Date(i.CreatedAt).toLocaleDateString()}',
                    '', // description if needed
                    '${i.IssueId}',
                    '${i.StudentId}'
                )">Link</button>
            </div>
        `).join('');


            container.html(html);
        }

    // INBOX role + name filters
    let inboxRoleFilters = [];

        function renderInboxRoleDropdown() {
            const container = $('#inboxRoleFilterDropdown');
            container.html('');
            inboxRoleFilters.forEach(role => {
                const safeId = 'inbox_' + role.replace(/\s/g, '');
                container.append(`
            <label><input type="checkbox" id="${safeId}" checked onchange="applyInboxFilters()">
            <span style="color:#7F3D98;">${role}</span></label>
        `);
            });
        }


        function applyInboxFilters() {
            const selectedRoles = [];
            $('#inboxRoleFilterDropdown input:checked').each(function () {
                selectedRoles.push($(this).parent().text().trim().toLowerCase());
            });

            const search = $('#inboxSearch').val().toLowerCase();
            $('#conversationContainer .conversation-item').each(function () {
                const name = $(this).data('name');
                const role = $(this).data('role');
                const matchesSearch = name.includes(search);
                const matchesRole = selectedRoles.includes(role);
                $(this).toggle(matchesSearch && matchesRole);
            });
        }

        function toggleInboxFilterDropdown() {
            const dropdown = document.getElementById("inboxRoleFilterDropdown");
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
        }

    // Close dropdown if clicked outside
    $(document).on('click', function (e) {
        if (!$(e.target).closest('#inboxRoleFilterDropdown, .filter-icon-btn').length) {
            $('#inboxRoleFilterDropdown').hide();
        }
        if (!$(e.target).closest('#roleFilterDropdown, .filter-icon-btn').length) {
            $('#roleFilterDropdown').hide();
        }
    });
    </script>
}
