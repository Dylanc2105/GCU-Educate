@{
    ViewBag.Title = "Messages";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="dm-wrapper">
    <div class="inbox-pane" id="inboxList">
        <div class="inbox-header">
            <div class="inbox-controls">
                <input type="text" id="inboxSearch" class="conversation-search" placeholder="Search messages..." onkeyup="applyInboxFilters()">

                <button class="filter-icon-btn" onclick="toggleInboxFilterDropdown()">
                    <span></span>
                </button>

                <button class="new-chat-btn" onclick="openNewChatModal()">+ New Chat</button>
            </div>
            <div id="inboxRoleFilterDropdown" class="role-dropdown static-dropdown" style="display: none;"></div>
        </div>
        <div id="conversationContainer">
            <p class="text-center p-3">Loading conversations...</p>
        </div>
    </div>

    <div class="chat-pane">
        <div class="chat-messages" id="messageList">
            <p class="text-center text-muted">Select a conversation to start chatting</p>
        </div>
        <div class="chat-input message-box" data-conversation-id="">
            <input type="text" id="messageText" placeholder="Type a message..." />
            <button id="sendBtn" onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div id="newChatModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Start New Chat</h3>
            <div style="position: relative;">
                <button class="filter-icon-btn" onclick="toggleRoleDropdown()">
                    <span></span>
                </button>
                <div id="roleFilterDropdown" class="role-dropdown">
                    <!-- Checkboxes injected by JS -->
                </div>
            </div>
            <button class="close-btn" onclick="closeNewChatModal()">×</button>
        </div>
        <input type="text" id="userSearch" placeholder="Search by name..." onkeyup="filterUserList()">
        <div id="userList" class="user-list">
            <p>Loading users...</p>
        </div>
    </div>
</div>
<style>
    /* Core layout */
    .dm-wrapper {
        display: flex;
        height: 80vh;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    .inbox-pane {
        width: 35%;
        background: #f4f4f4;
        border-right: 1px solid #ddd;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .inbox-header {
        background: #f4f4f4;
        border-bottom: 1px solid #ddd;
        text-align: center;
    }

    .new-chat-btn {
        background: #7F3D98;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 14px;
    }
    /* Inbox filter/search styling */
    .inbox-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 16px;
        background: #f4f4f4;
        border-bottom: 1px solid #ddd;
    }

        .inbox-controls .inbox-search {
            flex-grow: 1;
            margin-right: 10px;
        }

            .inbox-controls .inbox-search input {
                width: 100%;
                padding: 6px 12px;
                border: 1px solid #ccc;
                border-radius: 20px;
                font-size: 14px;
            }

        .inbox-controls .filter-icon-btn {
            background: none;
            border: none;
            position: relative;
            width: 22px;
            height: 22px;
            margin-left: 5px;
            cursor: pointer;
        }

            .inbox-controls .filter-icon-btn::before,
            .inbox-controls .filter-icon-btn::after,
            .inbox-controls .filter-icon-btn span {
                content: '';
                position: absolute;
                height: 3px;
                background: #7F3D98;
                left: 0;
                border-radius: 3px;
            }

            .inbox-controls .filter-icon-btn::before {
                top: 2px;
                width: 20px;
            }

            .inbox-controls .filter-icon-btn span {
                top: 9px;
                width: 16px;
            }

            .inbox-controls .filter-icon-btn::after {
                top: 16px;
                width: 12px;
            }

    .inbox-role-badge {
        display: inline-block;
        padding: 2px 10px;
        background: #7F3D98;
        color: white;
        font-size: 11px;
        font-weight: 500;
        border-radius: 12px;
        margin-top: 4px;
        width: fit-content; 
        white-space: nowrap; 
    }


    /* Conversation styling */
    .conversation-item {
        padding: 15px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        flex-direction: column;
    }

        .conversation-item:hover {
            background: #e9e9e9;
        }

        .conversation-item.unread strong {
            font-weight: bold;
            color: #7F3D98;
        }

        .conversation-item .preview {
            color: #555;
            font-size: 14px;
        }
    .conversation-search {
        padding: 10px 15px;
        border: 1px solid #ccc;
        border-radius: 20px;
        font-size: 14px;
        width: 60%;
        outline: none;
        margin-right: 10px;
    }

    /* Chat area */
    .chat-pane {
        flex-grow: 1;
        padding: 20px;
        background: #fff;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .chat-messages {
        overflow-y: auto;
        flex-grow: 1;
        padding-right: 10px;
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
    }

    .message-bubble {
        max-width: 70%;
        padding: 10px 15px;
        margin-bottom: 10px;
        border-radius: 15px;
        position: relative;
        clear: both;
        word-wrap: break-word;
    }

        .message-bubble.mine {
            background: #7F3D98;
            color: white;
            margin-left: auto;
        }

        .message-bubble.their {
            background: #e0e0e0;
            color: black;
            margin-right: auto;
        }

    .message-meta {
        font-size: 10px;
        margin-top: 4px;
        color: #888;
    }

    /* Input area */
    .chat-input {
        display: flex;
        gap: 10px;
    }

        .chat-input input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
        }

        .chat-input button {
            background: #7F3D98;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
        }

    /* Modal styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: 10px;
        width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        padding: 20px;
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

        .modal-header h3 {
            margin: 0;
            color: #7F3D98;
        }

    .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #7F3D98;
    }

    .user-list div {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .role-dropdown.static-dropdown {
        position: static !important;
        margin: 0 16px 10px 16px; 
        box-shadow: none;
        border: 1px solid #ccc;
        display: none; 
    }

        .user-list div:hover {
            background: #f0f0f0;
        }

    /* Filter Icon: Tapered Hamburger */
    .filter-icon-btn {
        background: none;
        border: none;
        width: 22px;
        height: 22px;
        position: relative;
        cursor: pointer;
        color: #7F3D98;
    }

        .filter-icon-btn::before,
        .filter-icon-btn::after,
        .filter-icon-btn span {
            content: '';
            position: absolute;
            height: 3px;
            background: #7F3D98;
            left: 0;
            border-radius: 3px;
        }

        .filter-icon-btn span {
            top: 9px;
            width: 16px;
        }

        .filter-icon-btn::before {
            top: 2px;
            width: 20px;
        }

        .filter-icon-btn::after {
            top: 16px;
            width: 12px;
        }

    /* Role Dropdown */
    .role-dropdown {
        position: absolute;
        top: 30px;
        right: 0;
        background: white;
        border: 1px solid #ccc;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        display: none;
        padding: 10px 15px;
        z-index: 1000;
        width: 200px;
    }

        .role-dropdown label {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #7F3D98;
            margin-bottom: 8px;
        }

        .role-dropdown input[type="checkbox"] {
            margin-right: 8px;
        }

    /* Role Badge Styling */
    .role-badge {
        font-size: 11px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 12px;
        color: white;
        margin-left: 8px;
    }

    .role-GuidanceTeacher {
        background-color: #7F3D98;
    }

    .role-Student {
        background-color: #2196F3;
    }

    .role-Lecturer {
        background-color: #4CAF50;
    }
</style>
@section scripts {
    <script>
    let currentConversationId = null;
    let allowedRoles = [];

    $(document).ready(function () {
        loadInbox();
    });

    function loadInbox() {
    $.get('@Url.Action("Inbox", "Message")', function (data) {
        let html = '';
        data.forEach(c => {
            html += `<div class="conversation-item ${c.UnreadCount > 0 ? 'unread' : ''}"
                            data-name="${c.Name}" data-role="${c.Role}"
                            onclick="loadMessages(${c.Id}, '${c.Name.replace("'", "\\'")}')">
                        <strong>${c.Name}</strong>
                        <span class="inbox-role-badge">${c.Role}</span>
                        <div class="preview">${c.LastMessage || 'No messages yet'}</div>
                        ${c.UnreadCount > 0 ? `<div class="message-meta">${c.UnreadCount} unread</div>` : ''}
                    </div>`;
        });
        document.getElementById("conversationContainer").innerHTML = html || '<p class="text-center text-muted">No conversations yet.</p>';
        setupInboxFilters(data);
    });
}

    function loadMessages(convoId, name) {
        currentConversationId = convoId;
        $('#messageList').html('<p class="text-center">Loading messages with ' + name + '...</p>');

        $.ajax({
            url: '@Url.Action("GetMessages", "Message")' + '?conversationId=' + convoId,
            method: 'GET',
            success: function (data) {
                if (!data || data.length === 0) {
                    $('#messageList').html('<p class="text-center text-muted">No messages found.</p>');
                    return;
                }

                data.sort((a, b) => new Date(a.SentAt) - new Date(b.SentAt));
                let html = '';
                data.forEach(msg => {
                    html += `<div class="message-bubble ${msg.IsMine ? 'mine' : 'their'}">
                                ${msg.Content}
                                <div class="message-meta">${msg.SenderName} • ${new Date(msg.SentAt).toLocaleTimeString()}</div>
                             </div>`;
                });
                $('#messageList').html(html);
                scrollChatToBottom();
            },
            error: function () {
                $('#messageList').html('<p class="text-center text-danger">Failed to load messages.</p>');
            }
        });
    }

    function scrollChatToBottom() {
        const chat = $('.chat-messages');
        chat.scrollTop(chat[0].scrollHeight);
    }

    function sendMessage() {
        const text = $('#messageText').val().trim();
        if (!text || currentConversationId === null) return;

        $.post('@Url.Action("SendMessage", "Message")', {
            conversationId: currentConversationId,
            content: text
        }, function () {
            $('#messageText').val('');
            loadMessages(currentConversationId);
            loadInbox();
        });
    }

    function openNewChatModal() {
        $('#newChatModal').show();
        loadAvailableUsers();
    }

    function closeNewChatModal() {
        $('#newChatModal').hide();
        $('#userSearch').val('');
        $('#userList').html('<p>Loading users...</p>');
    }

    function toggleRoleDropdown() {
        $('#roleFilterDropdown').toggle();
    }

    function loadAvailableUsers() {
        $.get('@Url.Action("GetAvailableUsers", "Message")', function (users) {
            const roleSet = new Set(users.map(u => u.Role));
            allowedRoles = Array.from(roleSet);
            renderRoleDropdown();

            const list = users.map(u =>
                `<div class="user-row" data-role="${u.Role.toLowerCase()}" onclick="startNewChat('${u.Id}')">
                    ${u.Name}
                    <div class="user-role">${u.Role}</div>
                </div>`
            ).join('');
            $('#userList').html(list || '<p>No users available</p>');
            filterByRoles();
        });
    }

    function renderRoleDropdown() {
        const container = $('#roleFilterDropdown');
        container.html('');
        allowedRoles.forEach(role => {
            const safeId = 'filter_' + role.replace(/\s/g, '');
            container.append(`
                <label><input type="checkbox" id="${safeId}" checked onchange="filterByRoles()"> ${role}</label>
            `);
        });
    }

    function filterByRoles() {
        const visibleRoles = [];
        $('#roleFilterDropdown input:checked').each(function () {
            visibleRoles.push($(this).parent().text().trim().toLowerCase());
        });

        $('#userList .user-row').each(function () {
            const role = $(this).data('role');
            $(this).toggle(visibleRoles.includes(role));
        });
    }

        function filterUserList() {
            const search = $('#userSearch').val().toLowerCase();
            $('#userList .user-row').each(function () {
                const name = $(this).contents().filter(function () {
                    return this.nodeType === 3; // Only text nodes
                }).text().toLowerCase();
                $(this).toggle(name.includes(search));
            });
        }


    function startNewChat(userId) {
        $.post('@Url.Action("StartConversation", "Message")', { userId }, function (data) {
            closeNewChatModal();
            loadInbox();
            loadMessages(data.conversationId, data.name);
        });
    }

    // INBOX role + name filters
    let inboxRoleFilters = [];

    function renderInboxRoleDropdown() {
        const container = $('#inboxRoleFilterDropdown');
        container.html('');
        inboxRoleFilters.forEach(role => {
            const safeId = 'inbox_' + role.replace(/\s/g, '');
            container.append(`
                <label><input type="checkbox" id="${safeId}" checked onchange="applyInboxFilters()">
                <span style="color:#7F3D98;">${role}</span></label>
            `);
        });
    }

    function applyInboxFilters() {
        const selectedRoles = [];
        $('#inboxRoleFilterDropdown input:checked').each(function () {
            selectedRoles.push($(this).parent().text().trim().toLowerCase());
        });

        const search = $('#inboxSearch').val().toLowerCase();
        $('#conversationContainer .conversation-item').each(function () {
            const name = $(this).data('name');
            const role = $(this).data('role');
            const matchesSearch = name.includes(search);
            const matchesRole = selectedRoles.includes(role);
            $(this).toggle(matchesSearch && matchesRole);
        });
    }

        function toggleInboxFilterDropdown() {
            const dropdown = document.getElementById("inboxRoleFilterDropdown");
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
        }

    // Close dropdown if clicked outside
    $(document).on('click', function (e) {
        if (!$(e.target).closest('#inboxRoleFilterDropdown, .filter-icon-btn').length) {
            $('#inboxRoleFilterDropdown').hide();
        }
        if (!$(e.target).closest('#roleFilterDropdown, .filter-icon-btn').length) {
            $('#roleFilterDropdown').hide();
        }
    });
    </script>
}

