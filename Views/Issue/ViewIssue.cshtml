@model GuidanceTracker.Models.Issue

@{
    ViewBag.Title = "Issue Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="issue-container">
    <!-- Left Section: Split into Issue Details & Appointments -->
    <div class="left-panel">
        <!-- Issue Details Container (70%) -->
        <div class="issue-details">
            <h1>@Model.IssueTitle</h1>
            <h2>Student Name: @Model.Student.FirstName @Model.Student.LastName</h2>
            <p><strong>Initial reason to raise issue:</strong> @Model.IssueDescription</p>
            <p><strong>Issue initiator:</strong> @Model.Lecturer.FirstName @Model.Lecturer.LastName</p>
            <p><strong>Status:</strong> @Model.IssueStatus</p>
            <p><strong>Created On:</strong> @Model.CreatedAt.ToString("dd/MM/yyyy")</p>
        </div>

        <!-- Appointments Container (30%) -->
        <div class="appointments-section">
            <h3>Appointments</h3>
            @if (Model.Student.Appointments != null && Model.Student.Appointments.Any())
            {
                <ul class="appointment-box">
                    @foreach (var appointment in Model.Student.Appointments)
                    {                        
                            <p><strong>@(appointment.AppointmentDate > DateTime.Now ? "Upcoming" : "Past") Appointment</strong></p>
                            <p><strong>Time:</strong> @appointment.AppointmentDate.ToString("dd/MM/yyyy HH:mm")</p>
                            <p><strong>Room:</strong> @appointment.Room</p>
                            <p><strong>Comments:</strong> @appointment.AppointmentNotes</p>
                            @Html.ActionLink("Edit Appointment", "Edit", "Appointment", new { id = appointment.AppointmentId }, new { @class = "btn btn-purple mt-2" })                        
                    }
                </ul>
            }
            else
            {
                <p>No appointments assigned.</p>
            }

            @Html.ActionLink("Create an Appointment", "Create", "Appointment", new { studentId = Model.StudentId }, new { @class = "btn btn-purple mt-2" })
        </div>
    </div>

    <!-- Right Section: Comments -->
    <div class="right-panel">
        <h3>Comments</h3>
        <div id="commentsContainer">
            @if (Model.Comments != null && Model.Comments.Any())
            {
                foreach (var comment in Model.Comments)
                {
                    <div class="comment-box">
                        <p><strong>@comment.User.FirstName @comment.User.LastName</strong> (@comment.CreatedAt.ToString("dd/MM/yyyy HH:mm"))</p>
                        <p>@comment.Content</p>
                    </div>
                }
            }
            else
            {
                <p>No comments yet. Add more information to help flesh out the issue.</p>
            }
        </div>

        <!-- Comment Form -->
        <h4>Write a comment...</h4>
        <form id="commentForm">
            @Html.AntiForgeryToken()
            <textarea id="commentInput" class="form-control" rows="4" placeholder="Write a comment..."></textarea>
            <button type="submit" class="btn btn-purple mt-2">Post Comment</button>
        </form>
    </div>
</div>

<!-- ✅ JavaScript for Comment Submission (Now Fixed) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        console.log("✅ ViewIssue Page Loaded");

        // ✅ Handle Comment Submission
        $("#commentForm").submit(function (e) {
            e.preventDefault();

            var commentContent = $("#commentInput").val().trim();
            if (commentContent === "") {
                alert("❌ Comment cannot be empty.");
                return;
            }

            $.ajax({
                url: "@Url.Action("AddComment", "Issue")",
                type: "POST",
                data: {
                    ticketId: @Model.IssueId,
                    content: commentContent,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        $("#commentsContainer").append(`
                            <div class="comment-box">
                                <p><strong>You</strong> (Just now)</p>
                                <p>${commentContent}</p>
                            </div>
                        `);
                        $("#commentInput").val(""); // ✅ Clear input correctly
                    } else {
                        alert("❌ Error: " + response.error);
                    }
                },
                error: function () {
                    alert("❌ Failed to submit the comment.");
                }
            });
        });
    });
</script>

<!-- ✅ Styles for Fixed Two-Column Layout with 70/30 Split -->
<style>
    .issue-container {
        display: flex;
        gap: 20px;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
        height: 90vh; /* Fixed height for a structured layout */
    }

    .issue-details {
        background: #ffffff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        overflow-y: auto; /* Allow scrolling if needed */
        height: 70%; /* Adjusted to take 70% */
    }


    .right-panel {
        width: 40%;
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        height: 100%;
        overflow-y: auto; /* Ensures comments don't stretch the page */
    }

    .comment-box {
        background: #fff;
        padding: 10px;
        margin: 10px 0;
        border-left: 5px solid #7F3D98;
        border-radius: 5px;
    }

    .btn-purple {
        background-color: #7F3D98 !important;
        color: white !important;
        border: none !important;
    }

        .btn-purple:hover {
            background-color: #985BAF !important;
        }

    .appointment-box {
        background: #f9f9f9;
        padding: 10px;
        margin: 10px 5px;
        border-radius: 5px;
        border-left: 5px solid #7F3D98;
    }
</style>


@* appointments info *@


<br />
