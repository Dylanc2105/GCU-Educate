@model GuidanceTracker.Models.Issue
@using GuidanceTracker.Models
@using Microsoft.AspNet.Identity

@{
    ViewBag.Title = "Issue Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="issue-page-wrapper">
    <!-- LEFT SECTION -->
    <div class="issue-main-panel">
        <div class="issue-summary">
            <h1>@Model.IssueTitle</h1>
            <p><strong>Student:</strong> @Model.Student.FirstName @Model.Student.LastName</p>
            <p><strong>Raised by:</strong> @Model.Lecturer.FirstName @Model.Lecturer.LastName</p>
            <!-- karina: added a dropdown so status can be changed -->
            @if (User.IsInRole("GuidanceTeacher"))
            {
                <!-- status dropdown for guidance only -->
                <div class="status-control-group">
                    <p><strong>Status:</strong></p>
                    <select id="statusDropdown" class="form-control status-select">
                        @foreach (var status in Enum.GetValues(typeof(GuidanceTracker.Models.IssueStatus)))
                        {
                            <option value="@status" @(Model.IssueStatus.ToString() == status.ToString() ? "selected" : "")>@status</option>
                        }
                    </select>
                    <button id="updateStatusBtn" class="btn btn-purple btn-sm">Update Status</button>
                </div>
            }
            else
            {
                <!-- lecturers only see the status -->
                <p><strong>Status:</strong> <span class="status-badge status-@Model.IssueStatus.ToString().ToLower()">@Model.IssueStatus.ToString()</span></p>
            }
            <p><strong>Date Created:</strong> @Model.CreatedAt.ToString("dd/MM/yyyy")</p>
            <div class="issue-description">
                <h4>Description</h4>
                <p>@Model.IssueDescription</p>
            </div>
        </div>

        <div class="appointments-panel">
            <h4>Appointments</h4>
            @if (Model.Student.Appointments != null && Model.Student.Appointments.Any())
            {
                foreach (var appointment in Model.Student.Appointments)
                {
                    <div class="appointment-card">
                        <p><strong>@(appointment.AppointmentDate > DateTime.UtcNow ? "Upcoming" : "Past")</strong></p>
                        <p><strong>Date:</strong> @appointment.AppointmentDate.ToString("dd/MM/yyyy")</p>
                        <p><strong>Time:</strong> @appointment.StartTime</p>
                        <p><strong>Room:</strong> @appointment.Room</p>
                        <p><strong>Notes:</strong> @appointment.AppointmentNotes</p>
                        @Html.ActionLink("Edit", "Edit", "Appointment", new { id = appointment.AppointmentId }, new { @class = "btn btn-purple small" })
                    </div>
                }
            }
            else
            {
                <p>No appointments recorded.</p>
            }
            @Html.ActionLink("Create Appointment", "CreateAppointmentWithIssue", "Appointment", new { issueId = Model.IssueId }, new { @class = "btn btn-purple mt-2" })
        </div>
    </div>

    <!-- RIGHT SECTION -->
    <div class="issue-comments-panel">
        <h3>Comments</h3>
        <div id="commentsContainer">
            @if (Model.Comments != null && Model.Comments.Any())
            {
                foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedAt))
                {
                    bool isGroup = comment.Content.StartsWith("This issue was raised as part of a group involving");
                    //Billy: check if the comment is from the current user
                    bool isCurrentUser = comment.UserId == User.Identity.GetUserId();

                    <div class="comment-box @(isGroup ? "group-comment" : "") @(isCurrentUser ? "my-comment" : "")">
                        @if (!isGroup)
                        {
                            <p class="comment-author">
                                <!-- Billy: Shows "You" if the comment was created by the current usr, otherwise shows the users full name -->
                                <strong>@(isCurrentUser ? "You" : comment.User.FirstName + " " + comment.User.LastName)</strong>
                                <span class="comment-date">(@comment.CreatedAt.ToString("dd/MM/yyyy HH:mm"))</span>
                            </p>
                        }
                        <p class="comment-text">@comment.Content</p>
                    </div>
                }
            }
            else
            {
                <p>No comments yet.</p>
            }
        </div>
        <!-- karina: Added user validation. if its a guidance teahcer they can add a comment-->
        @if (User.IsInRole("GuidanceTeacher"))
        {
            <form id="commentForm">
                @Html.AntiForgeryToken()
                <textarea id="commentInput" class="form-control" rows="4" placeholder="Write a comment..."></textarea>
                <button type="submit" class="btn btn-purple mt-2">Post Comment</button>
            </form>
        }
        <!-- karina: if the user is a lecturer they can add to the issue by choosing the unit and commenting-->
        @if (User.IsInRole("Lecturer"))
        {
            <form id="lecturerAddToIssueForm">
                @Html.AntiForgeryToken()

                <div class="form-group">
                    <label>Related Unit:</label>
                    <select id="unitDropdown" class="form-control">
                        <option value="">-- Select Unit --</option>
                        @foreach (var unit in ((IEnumerable<Unit>)ViewBag.LecturerUnits))
                        {
                            <option value="@unit.UnitId">@unit.UnitName</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label for="lecturerComment">Add to this issue:</label>
                    <textarea id="lecturerComment" class="form-control" rows="3"
                              placeholder="Write a comment..."></textarea>
                </div>

                <button type="submit" class="btn btn-purple">Add Comment</button>
            </form>
        }
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(function () {
            $("#commentForm").submit(function (e) {
                e.preventDefault();
                const comment = $("#commentInput").val().trim();
                if (!comment) return alert("Comment cannot be empty.");

                $.post("@Url.Action("AddComment", "Issue")", {
                    ticketId: @Model.IssueId,
                    content: comment,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                }, function (res) {
                    if (res.success) {
                        $("#commentsContainer").prepend(`
                            <div class='comment-box'>
                                <p><strong>You</strong> (Just now)</p>
                                <p>${comment}</p>
                            </div>`);
                        $("#commentInput").val("");
                    } else {
                        alert("Error: " + res.error);
                    }
                });
            });
        });

        // karina: function to handle form submisison when a lecturer add to an existing issue
        $("#lecturerAddToIssueForm").submit(function(e) {
            e.preventDefault();
            const comment = $("#lecturerComment").val().trim();
            const unitId = $("#unitDropdown").val();

            if (!comment) return alert("Comment cannot be empty.");
            if (!unitId) return alert("Please select a unit.");

            // sends AJAX POST request to add the comment
            $.post("@Url.Action("AddLecturerComment", "Issue")", {
                issueId: @Model.IssueId,
                content: comment,
                unitId: unitId,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            }, function(res) {
                if (res.success) {
                    // get selected unit for the display
                    const unitName = $("#unitDropdown option:selected").text();
                    $("#commentsContainer").prepend(`
                        <div class='comment-box my-comment'>
                            <p><strong>You</strong> (Just now)</p>
                            <p><strong>Related to ${unitName}:</strong> ${comment}</p>
                        </div>`);
                    $("#lecturerComment").val("");
                } else {
                    alert("Error: " + res.error);
                }
            });
        });
        // karina: handle click event for guidance teahcers to update the status
        $("#updateStatusBtn").click(function(e) {
            e.preventDefault();
            const newStatus = $("#statusDropdown").val();

            $.post("@Url.Action("UpdateIssueStatus", "Issue")", {
                issueId: @Model.IssueId,
                status: newStatus
            }, function(res) {
                if (res.success) {
                    alert("Status updated successfully!");
                } else {
                    alert("Error: " + res.error);
                }
            });
        });
    </script>
}

<style>
    .issue-page-wrapper {
        display: flex;
        gap: 30px;
        padding: 20px;
        max-width: 1200px;
        margin: auto;
    }

    .issue-main-panel {
        flex: 3;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .issue-summary, .appointments-panel {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.06);
    }

    .issue-description p {
        margin-top: 10px;
        font-size: 15px;
    }

    .appointment-card {
        padding: 10px;
        background: #f4f4f4;
        border-left: 4px solid #7F3D98;
        margin-bottom: 10px;
        border-radius: 6px;
    }

    .btn-purple {
        background-color: #7F3D98;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 14px;
        font-weight: 600;
        cursor: pointer;
    }

        .btn-purple.small {
            font-size: 12px;
            padding: 4px 10px;
        }

        .btn-purple:hover {
            background-color: #985BAF;
        }

    .issue-comments-panel {
        flex: 2;
        display: flex;
        flex-direction: column;
        background: #f9f9ff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.06);
        max-height: 85vh;
        overflow-y: auto;
    }

    .comment-box {
        background: white;
        padding: 10px 15px;
        margin-bottom: 12px;
        border-left: 4px solid #7F3D98;
        border-radius: 5px;
    }

    .group-comment {
        background: #f3f0ff;
        border-left-color: #985BAF;
        font-style: italic;
    }

    .comment-author {
        font-weight: bold;
        font-size: 14px;
    }

    .comment-date {
        font-size: 12px;
        color: #888;
        margin-left: 6px;
    }

    .comment-text {
        margin-top: 5px;
        font-size: 14px;
    }

    textarea.form-control {
        resize: vertical;
        font-size: 14px;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
    }

    .status-select {
        display: inline-block;
        width: auto;
        margin-right: 10px;
        padding: 4px 8px;
    }

    #updateStatusBtn {
        vertical-align: middle;
    }
</style>