@model List<GuidanceTracker.Models.Issue>
@using GuidanceTracker.Models

@{
    ViewBag.Title = "Issues Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<!-- Ensure jQuery is loaded -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
    .body {
        background-color: white;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
    }

    .dashboard-card {
        padding: 18px 0;
        background-color: white;
        border-radius: 10px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        max-width: 1500px;
        margin: 0 auto;
    }

    .dashboard-title {
        font-size: 28px;
        font-weight: bold;
        color: #7F3D98;
        margin-bottom: 18px;
        text-align: center;
    }

    /* Three column layout */
    .dashboard-container {
        display: grid;
        grid-template-columns: 1fr 1fr 0.7fr;
        gap: 20px;
        padding: 0 22px 20px 22px;
    }

    .container,
    .bottom-right-container {
        background: white;
        padding: 13px;
        border-radius: 10px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
        min-height: 180px;
    }

    .container {
        min-width: 0;
    }

    .bottom-right-container {
        min-width: 220px;
        max-width: 320px;
        padding: 13px 7px;
    }

    .section-title {
        font-size: 20px;
        font-weight: bold;
        color: #7F3D98;
        margin-bottom: 12px;
        text-align: center;
    }

    /* Issue Cards */
    .issue-card {
        padding: 7px 8px;
        border-left: 5px solid #7F3D98;
        margin-bottom: 6px;
        background: #FAFAFA;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
    }

        .issue-card.issue-header {
            background: #f8f9fa;
            border-bottom: 1px solid #eaecef;
            border-left: none;
            font-weight: bold;
            cursor: default;
            pointer-events: none;
            margin-bottom: 5px;
        }

        .issue-card:hover {
            background: #EEE;
        }

    .issue-main {
        font-weight: bold;
        font-size: 13px;
    }

    .issue-update {
        font-size: 12px;
        color: #555;
    }

    .issue-date {
        font-size: 10px;
        color: #888;
    }

    .issue-footer {
        font-size: 10px;
        text-align: right;
        padding-top: 3px;
        font-style: italic;
        color: black;
    }

    /* Quick Actions */
    .quick-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 0;
        border-radius: 8px;
    }

    .quick-btn-group {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        width: 100%;
        gap: 9px;
    }

    .quick-btn {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 10px 10px;
        background: #7F3D98;
        border: 1px solid #7F3D98;
        border-radius: 7px;
        color: #fff;
        font-weight: 600;
        font-size: 1em;
        text-decoration: none;
        transition: background 0.18s, color 0.18s;
        box-shadow: 0 1px 6px #e7d0fa34;
        min-height: 36px;
        min-width: 120px;
    }

        .quick-btn img {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .quick-btn:hover,
        .quick-btn:focus {
            background: #985BAF;
            color: #fff;
        }

    /* View More Button */
    .view-more-btn {
        background-color: #7F3D98;
        color: white;
        border: none;
        padding: 4px 9px;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 5px;
        font-size: 0.98em;
    }

        .view-more-btn:hover,
        .view-more-btn:focus {
            background: #985BAF;
            color: #fff;
        }

    /* Modal Styles */
    .full-issues-list {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
    }

    .modal-backdrop {
        background-color: rgba(0,0,0,0.5);
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background-color: white;
        width: 82%;
        max-width: 800px;
        max-height: 80vh;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.19);
        overflow: hidden;
    }

    .modal-header {
        padding: 11px 15px;
        background-color: #7F3D98;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ddd;
    }

        .modal-header img {
            width: 22px;
            height: 22px;
        }

    .modal-body {
        padding: 13px 15px;
        max-height: calc(80vh - 60px);
        overflow-y: auto;
    }

    .close-btn {
        font-size: 22px;
        cursor: pointer;
    }

        .close-btn:hover {
            color: #666;
        }

    .section-title img {
        width: 22px;
        height: 22px;
        vertical-align: middle;
        margin-left: 7px;
    }
</style>

<div class="dashboard-card">
    <h1 class="dashboard-title">Issues Dashboard</h1>
    <div class="dashboard-container">
        <!-- New Issues -->
        <div class="container">
            <div class="section-title"><img src="~/Images/Icons/OTHER/new.svg" /> New</div>
            <div class="issue-card issue-header">
                <div class="issue-main">Student</div>
                <div class="issue-main">Issue</div>
                <div class="issue-main">Date</div>
            </div>
            @foreach (var issue in Model.Where(t => t.IssueStatus == IssueStatus.New).OrderByDescending(t => t.CreatedAt).Take(4))
            {
                <div class="issue-card" onclick="window.location.href='@Url.Action("ViewIssue", "Issue", new { id = issue.IssueId })'">
                    <div class="issue-main">@issue.Student.FirstName @issue.Student.LastName</div>
                    <div class="issue-update">@issue.IssueTitle.ToString()</div>
                    <div class="issue-date">@issue.CreatedAt.ToString("dd/MM/yyyy")</div>
                </div>
            }
            <div class="issue-footer">
                Total New Issues: <strong>@Model.Count(t => t.IssueStatus == IssueStatus.New)</strong>
                @if (Model.Count(t => t.IssueStatus == IssueStatus.New) > 4)
                {
                    <button id="view-more-new" class="view-more-btn" onclick="toggleIssues('new')">View More</button>
                }
            </div>
        </div>

        <!-- In Progress Issues -->
        <div class="container">
            <div class="section-title"><img src="~/Images/Icons/OTHER/inProgress.svg" /> In Progress</div>
            <div class="issue-card issue-header">
                <div class="issue-main">Student</div>
                <div class="issue-main">Issue</div>
                <div class="issue-main">Date</div>
            </div>
            @foreach (var issue in Model.Where(t => t.IssueStatus == IssueStatus.InProgress).OrderByDescending(t => t.CreatedAt).Take(4))
            {
                <div class="issue-card" onclick="window.location.href='@Url.Action("ViewIssue", "Issue", new { id = issue.IssueId })'">
                    <div class="issue-main">@issue.Student.FirstName @issue.Student.LastName</div>
                    <div class="issue-update">Update to @issue.IssueTitle.ToString()</div>
                    <div class="issue-date">@issue.CreatedAt.ToString("dd/MM/yyyy")</div>
                </div>
            }
            <div class="issue-footer">
                Total In Progress Issues: <strong>@Model.Count(t => t.IssueStatus == IssueStatus.InProgress)</strong>
                @if (Model.Count(t => t.IssueStatus == IssueStatus.InProgress) > 4)
                {
                    <button id="view-more-inprogress" class="view-more-btn" onclick="toggleIssues('inprogress')">View More</button>
                }
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bottom-right-container">
            <div class="section-title">Quick Actions</div>
            <div class="quick-actions">
                <div class="quick-btn-group">
                    <a href="@Url.Action("CreateIssue", "Issue")" class="quick-btn">
                        <img src="~/Images/Icons/OTHER/createIssue.svg" /> Create New 
                    </a>
                    <a href="@Url.Action("StudentIssue", "Issue")" class="quick-btn">
                        <img src="~/Images/Icons/OTHER/studentHub.svg" /> Student Finder
                    </a>
                    <a href="@Url.Action("AllIssues", "Issue")" class="quick-btn">
                        <img src="~/Images/Icons/OTHER/allIssues.svg" /> All Active 
                    </a>
                    <a href="@Url.Action("ArchivedIssues", "Issue")" class="quick-btn">
                        <img src="~/Images/Icons/OTHER/archived.svg" /> Archived Issues
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal: Full lists for New and In Progress issues -->
    <div id="new-issues-full" class="full-issues-list" style="display: none;">
        <div class="modal-backdrop">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><img src="~/Images/Icons/OTHER/newWhite.svg" /> All New Issues</h2>
                    <span class="close-btn" onclick="toggleIssues('new')">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="issue-card issue-header">
                        <div class="issue-main">Student</div>
                        <div class="issue-main">Issue</div>
                        <div class="issue-main">Date</div>
                    </div>
                    @foreach (var issue in Model.Where(t => t.IssueStatus == IssueStatus.New).OrderByDescending(t => t.CreatedAt))
                    {
                        <div class="issue-card" onclick="window.location.href='@Url.Action("ViewIssue", "Issue", new { id = issue.IssueId })'">
                            <div class="issue-main">@issue.Student.FirstName @issue.Student.LastName</div>
                            <div class="issue-update">@issue.IssueTitle.ToString()</div>
                            <div class="issue-date">@issue.CreatedAt.ToString("dd/MM/yyyy")</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    <div id="in-progress-issues-full" class="full-issues-list" style="display: none;">
        <div class="modal-backdrop">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><img src="~/Images/Icons/OTHER/inProgressWhite.svg" /> All In Progress Issues</h2>
                    <span class="close-btn" onclick="toggleIssues('inprogress')">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="issue-card issue-header">
                        <div class="issue-main">Student</div>
                        <div class="issue-main">Issue</div>
                        <div class="issue-main">Date</div>
                    </div>
                    @foreach (var issue in Model.Where(t => t.IssueStatus == IssueStatus.InProgress).OrderByDescending(t => t.CreatedAt))
                    {
                        <div class="issue-card" onclick="window.location.href='@Url.Action("ViewIssue", "Issue", new { id = issue.IssueId })'">
                            <div class="issue-main">@issue.Student.FirstName @issue.Student.LastName</div>
                            <div class="issue-update">Update to @issue.IssueTitle.ToString()</div>
                            <div class="issue-date">@issue.CreatedAt.ToString("dd/MM/yyyy")</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // karina: this is for the view more issues button
    function toggleIssues(type) {
        var fullListId = type === 'new' ? 'new-issues-full' : 'in-progress-issues-full';
        var fullList = document.getElementById(fullListId);

        if (fullList.style.display === 'none') {
            fullList.style.display = 'block';
            document.body.style.overflow = 'hidden'; // prevents scrolling behind modal
        } else {
            fullList.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }
</script>
