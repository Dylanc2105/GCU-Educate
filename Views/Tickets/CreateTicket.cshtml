@model List<GuidanceTracker.Models.ViewModels.CourseViewModel>

@{
    ViewBag.Title = "Create New Issue";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Ensure jQuery is loaded -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
    .btn-purple {
        background-color: #7F3D98; /* Purple */
        color: white;
        border: none;
        padding: 8px 15px;
    }

        .btn-purple:hover {
            background-color: #985BAF; /* Lighter purple */
        }

    .btn-dark {
        background-color: black !important;
        color: white;
    }
</style>

<h1 class="dashboard-title">Create a New Issue</h1>

<div class="container mt-4">
    <!-- Class Selection Buttons -->
    <div class="class-selection">
        <h4>Select a Class:</h4>
        <div class="btn-group">
            @foreach (var course in Model)
            {
                <button class="btn btn-purple class-btn" data-courseid="@course.CourseId">@course.CourseName</button>
            }
        </div>
    </div>
</div>

<!-- Student Dropdown and Create Button -->
<div id="studentSelectionRow" class="d-flex align-items-center mt-3" style="gap: 10px;">
    <select id="studentSelect" class="form-control" style="max-width: 300px;">
        <option value="">Select a Student</option>
    </select>
    <a id="createNewIssue" class="btn btn-purple" href="javascript:void(0);">Create New Issue</a>
</div>

<!-- Student Details & Issues (Appears when student is selected) -->
<div id="studentDetails" class="mt-4" style="display: none;">
    <h4>Student Details</h4>
    <p><strong>Name:</strong> <span id="studentName"></span></p>
    <p><strong>Student Number:</strong> <span id="studentNumber"></span></p>
</div>

<!-- Issues List (Appears if student has existing issues) -->
<div id="issueList" class="mt-4" style="display: none;">
    <h4>Existing Issues</h4>
    <div id="issueCards" class="row">
        <!-- Issues will be dynamically loaded here -->
    </div>
</div>

<script>
    $(document).ready(function () {
        console.log("✅ JavaScript Loaded!");

        // Handle Class Button Click
        $(document).on("click", ".class-btn", function () {
            console.log("✅ Button Clicked!");
            var courseId = $(this).data("courseid");

            $(".class-btn").removeClass("btn-dark").addClass("btn-purple");
            $(this).removeClass("btn-purple").addClass("btn-dark");

            // Fetch students for the selected class
            $.ajax({
                url: "/Issues/GetStudents",
                type: "GET",
                data: { courseId: courseId },
                success: function (students) {
                    console.log("✅ Students Loaded:", students);

                    var studentSelect = $("#studentSelect");
                    studentSelect.empty().append('<option value="">Select a Student</option>');

                    $.each(students, function (i, student) {
                        studentSelect.append(`<option value="${student.Id}" data-number="${student.StudentNumber}">${student.Name}</option>`);
                    });

                    $("#studentDropdown").show();
                },
                error: function (xhr) {
                    console.error("❌ Error loading students:", xhr.responseText);
                    alert("Failed to load students.");
                }
            });
        });

        // Handle Student Selection
        $(document).on("change", "#studentSelect", function () {
            var selectedStudent = $(this).find(":selected");
            var studentId = selectedStudent.val();
            var studentName = selectedStudent.text();
            var studentNumber = selectedStudent.data("number");

            $("#studentName").text(studentName);
            $("#studentNumber").text(studentNumber);
            $("#studentDetails").show();

            // Fetch issues for the selected student
            $.ajax({
                url: "/Issues/GetStudentIssues",
                type: "GET",
                data: { studentId: studentId },
                success: function (issues) {
                    console.log("✅ Issues Loaded:", issues);

                    var issueCards = $("#issueCards");
                    issueCards.empty();

                    if (issues.length === 0) {
                        $("#issueList").hide(); // Hide if no issues
                    } else {
                        $.each(issues, function (i, issue) {
                            var issueHtml = `
                                <div class="card issue-card shadow-sm p-3 mb-3" style="border-left: 5px solid #7F3D98;">
                                    <h5 class="card-title">${issue.Title}</h5>
                                    <p class="card-text"><strong>Date:</strong> ${issue.Date}</p>
                                    <p class="card-text"><strong>Status:</strong> ${issue.Status}</p>
                                    <p class="card-text">${issue.Description}</p>
                                    <button class="btn btn-sm btn-outline-primary edit-issue" data-issueid="${issue.Id}">Edit Issue</button>
                                </div>
                            `;
                            issueCards.append(issueHtml);
                        });

                        $("#issueList").show();
                    }
                },
                error: function (xhr) {
                    console.error("❌ Error loading issues:", xhr.responseText);
                    alert("Failed to load issues.");
                }
            });
        });
    });
</script>

<script>
    $(document).ready(function () {
        $("#createNewIssue").click(function (e) {
            e.preventDefault(); // Stop default link behavior

            var studentId = $("#studentSelect").val();
            var studentName = $("#studentSelect option:selected").text();

            if (!studentId) {
                alert("Please select a student before creating an issue.");
                return;
            }

            // Redirect to NewIssue page with student details
            window.location.href = "/Issues/NewIssue?studentId=" + encodeURIComponent(studentId) + "&studentName=" + encodeURIComponent(studentName);
        });
    });
</script>
